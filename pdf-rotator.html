<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Page Rotator</title>
     <!-- Base CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Additional Libraries from Source File (Violates Original Constraints) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .dropzone {
            transition: all 0.3s ease;
        }
        .dropzone.active {
            border-color: #3b82f6;
            background-color: #f0f7ff;
        }
        .page-thumbnail {
            transition: all 0.2s ease;
        }
        .page-thumbnail:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .rotate-options button.active {
            background-color: #3b82f6;
            color: white;
        }
        #pdfPreview {
            max-height: 500px;
            overflow-y: auto;
        }
        /* Custom scrollbar for preview */
        #pdfPreview::-webkit-scrollbar {
            width: 8px;
        }
        #pdfPreview::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #pdfPreview::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        #pdfPreview::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Header -->
<!-- Header -->
 <header x-data="{ mobileMenuOpen: false }" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white shadow-md sticky top-0 z-50"> <!-- Blue gradient -->
    <nav class="container mx-auto px-4 sm:px-6 py-1 flex justify-between items-center">
        <!-- Logo Link -->
        <a href="index.html" class="flex items-center transition duration-150 ease-in-out hover:opacity-80">
           <img src="logo.png" alt="SmileyPDF Logo" class="h-20 w-auto mr-2"> <!-- UPDATED: h-20 logo size -->
        </a>

        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center space-x-4">
            <a href="index.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Home</a>
            <!-- Tools Dropdown -->
             <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @keydown.escape.window="open = false" class="hover:text-blue-200 font-medium focus:outline-none flex items-center px-3 py-2 rounded-md text-sm">
                    Tools <i class="fas fa-chevron-down ml-1 text-xs"></i>
                </button>
                <div x-show="open" @click.away="open = false"
                     x-transition:enter="transition ease-out duration-100 transform"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75 transform"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20 text-gray-700 py-1 origin-top-right"
                     style="display: none;" x-cloak>
                     <a href="pdf-editor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF Editor</a>
                     <a href="merge-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Merge PDF</a>
                     <a href="image-to-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Image to PDF</a>
                     <a href="pdf-rotator.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Rotate PDF</a>
                     <a href="pdf-text-extractor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Extract PDF Text</a>
                     <a href="pdf-to-jpg.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to JPG</a>
                     <a href="pdf-to-word.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Word</a>
                 </div>
             </div>
         </div>
          <!-- Mobile Menu Button -->
          <div class="md:hidden">
              <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white focus:outline-none p-2 rounded hover:bg-blue-600">
                  <span class="sr-only">Open menu</span>
                  <i x-show="!mobileMenuOpen" class="fa-solid fa-bars text-xl"></i>
                  <i x-show="mobileMenuOpen" class="fa-solid fa-times text-xl" style="display: none;" x-cloak></i>
              </button>
         </div>
    </nav>
     <!-- Mobile Menu Panel -->
     <div x-show="mobileMenuOpen"
         @click.away="mobileMenuOpen = false"
         class="md:hidden absolute inset-x-0 top-full bg-blue-600 shadow-lg border-t border-blue-500"
         x-transition:enter="transition ease-out duration-200 transform origin-top"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75 transform origin-top"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         style="display: none;" x-cloak>
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Home</a>
            <h3 class="px-3 pt-4 pb-1 text-xs font-semibold text-blue-200 uppercase tracking-wider">Tools</h3>
            <a href="pdf-editor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF Editor</a>
            <a href="merge-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Merge PDF</a>
            <a href="image-to-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Image to PDF</a>
            <a href="pdf-rotator.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Rotate PDF</a>
            <a href="pdf-text-extractor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Extract PDF Text</a>
            <a href="pdf-to-jpg.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to JPG</a>
            <a href="pdf-to-word.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Word</a>
        </div>
     </div>
</header>
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">PDF Page Rotator</h1>
                <p class="text-gray-600">Select pages and rotate them clockwise or counterclockwise</p>
            </div>

            <!-- File Upload Section -->
            <div class="mb-8">
                <div id="dropzone" class="dropzone border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-400">
                    <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-file-pdf text-5xl text-red-500 mb-4"></i>
                        <p class="text-lg font-medium text-gray-700 mb-2">Drag & drop your PDF file here</p>
                        <p class="text-gray-500 mb-4">or</p>
                        <label for="fileInput" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition cursor-pointer">
                            Select File
                        </label>
                        <input id="fileInput" type="file" accept=".pdf" class="hidden">
                    </div>
                </div>
                <div id="fileNameDisplay" class="mt-2 text-sm text-gray-600 hidden"></div>
                <div id="fileError" class="mt-2 text-sm text-red-500 hidden"></div>
            </div>

            <!-- Rotation Controls Section -->
            <div id="controlsSection" class="hidden mb-8">
                <div class="bg-gray-100 rounded-lg p-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Rotation Options</h2>
                    
                    <div class="flex flex-wrap items-center gap-4 mb-4">
                        <div class="rotate-options flex gap-2">
                            <button data-degrees="90" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-redo mr-2"></i>90° Clockwise
                            </button>
                            <button data-degrees="-90" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-undo mr-2"></i>90° Counter-clockwise
                            </button>
                            <button data-degrees="180" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-sync-alt mr-2"></i>180°
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-700">Selected Pages:</span>
                            <input type="text" id="pageRangeInput" placeholder="e.g. 1,3,5-8" class="border border-gray-300 rounded px-3 py-1 w-40">
                            <button id="applySelection" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                Apply
                            </button>
                        </div>
                        <div>
                            <button id="selectAll" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 transition">
                                Select All
                            </button>
                            <button id="clearSelection" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 transition ml-2">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div id="previewSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Page Preview</h2>
                <div class="mb-4 text-sm text-gray-600 flex justify-between items-center">
                    <div>
                        <span id="totalPages" class="font-medium"></span> pages in total
                    </div>
                    <button id="rotateSelected" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Rotate Selected
                    </button>
                </div>
                <div id="pdfPreview" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-2 bg-gray-50 rounded-lg border border-gray-200">
                    <!-- Page thumbnails will be inserted here -->
                </div>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="hidden mt-8 text-center">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-4">
                    <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-green-800 mb-2">PDF Successfully Processed!</h3>
                    <p class="text-green-600">Your file is ready to download.</p>
                </div>
                <button id="downloadBtn" class="px-6 py-3 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition inline-flex items-center">
                    <i class="fas fa-download mr-2"></i> Download Rotated PDF
                </button>
                <button id="newFileBtn" class="px-6 py-3 ml-4 border border-gray-300 rounded-lg font-medium hover:bg-gray-100 transition inline-flex items-center">
                    <i class="fas fa-redo mr-2"></i> Process Another File
                </button>
            </div>
        </div>

        <div class="mt-8 text-center text-sm text-gray-500">
            <p>This tool processes your PDF files entirely in your browser. No data is sent to any server.</p>
        </div>
    </div>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const fileError = document.getElementById('fileError');
            const controlsSection = document.getElementById('controlsSection');
            const previewSection = document.getElementById('previewSection');
            const resultSection = document.getElementById('resultSection');
            const pdfPreview = document.getElementById('pdfPreview');
            const totalPagesDisplay = document.getElementById('totalPages');
            const rotateOptions = document.querySelectorAll('.rotate-options button');
            const pageRangeInput = document.getElementById('pageRangeInput');
            const applySelection = document.getElementById('applySelection');
            const selectAll = document.getElementById('selectAll');
            const clearSelection = document.getElementById('clearSelection');
            const rotateSelected = document.getElementById('rotateSelected');
            const downloadBtn = document.getElementById('downloadBtn');
            const newFileBtn = document.getElementById('newFileBtn');

            // State variables
            let pdfDoc = null; // pdf-lib document
            let pdfJsDoc = null; // pdf.js document
            let selectedPages = [];
            let currentRotation = 0;
            let pdfBytes = null;
            let currentFile = null;

             // Check for library presence
            if (typeof window.pdfjsLib === 'undefined' || typeof window.PDFLib === 'undefined' || typeof window.saveAs === 'undefined') {
               showError("Required libraries (pdf.js, pdf-lib, FileSaver) could not be loaded.");
               console.error("Missing required libraries.");
               return; // Stop execution if libraries are missing
           }
           const { degrees } = window.PDFLib;

            // Event Listeners
            fileInput.addEventListener('change', handleFileSelect, false);
            
            dropzone.addEventListener('dragover', handleDragOver);
            dropzone.addEventListener('dragleave', handleDragLeave);
            dropzone.addEventListener('drop', handleDrop);

            // Only trigger the click on the label, not the entire dropzone
            dropzone.addEventListener('click', function(e) {
                if (e.target === dropzone || e.target.closest('.flex-col') === dropzone.querySelector('.flex-col')) {
                     if (e.target.tagName !== 'LABEL') { // Prevent double click trigger if clicking label itself
                        fileInput.click();
                     }
                }
            });

            rotateOptions.forEach(option => {
                option.addEventListener('click', function() {
                    currentRotation = parseInt(this.getAttribute('data-degrees'));
                    rotateOptions.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            applySelection.addEventListener('click', applyPageRange);
            selectAll.addEventListener('click', selectAllPages);
            clearSelection.addEventListener('click', clearAllPages);
            rotateSelected.addEventListener('click', processRotation);
            downloadBtn.addEventListener('click', downloadRotatedPDF);
            newFileBtn.addEventListener('click', resetTool);

            // Functions
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.add('active');
            }

            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.remove('active');
            }

            async function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.remove('active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    await handleFileUpload(files[0]);
                } else {
                    showError('Please upload a valid PDF file.');
                }
            }

            async function handleFileSelect(e) {
                const file = e.target.files[0];
                if (!file) return;
                await handleFileUpload(file);
            }

            async function handleFileUpload(file) {
                if (file.type !== 'application/pdf') {
                    showError('Please upload a valid PDF file.');
                    return;
                }
                
                resetTool(); // Reset state before loading new file
                currentFile = file;
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    pdfBytes = new Uint8Array(arrayBuffer); // Keep original bytes
                    
                    // Load PDF with both libraries
                    pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                    pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    
                    // Display file info
                    fileNameDisplay.textContent = `File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    fileNameDisplay.classList.remove('hidden');
                    fileError.classList.add('hidden');
                    
                    // Show controls and preview sections
                    controlsSection.classList.remove('hidden');
                    previewSection.classList.remove('hidden');
                    resultSection.classList.add('hidden');
                    
                    // Display page count
                    const pageCount = pdfDoc.getPageCount();
                    totalPagesDisplay.textContent = pageCount;
                    
                    // Render page thumbnails
                    await renderPageThumbnails(pageCount);
                    
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    showError('Error loading PDF. It might be corrupted or password-protected.');
                }
            }

            async function renderPageThumbnails(pageCount) {
                pdfPreview.innerHTML = '';
                
                for (let i = 0; i < pageCount; i++) {
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'page-thumbnail bg-white p-2 rounded-md border border-gray-200 cursor-pointer relative';
                    pageContainer.dataset.pageIndex = i;
                    
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'flex flex-col items-center';
                    
                    const pageNumber = document.createElement('div');
                    pageNumber.className = 'text-sm font-medium text-gray-700 mb-2';
                    pageNumber.textContent = `Page ${i + 1}`;
                    
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'w-full h-32 bg-gray-100 flex items-center justify-center overflow-hidden relative mb-2';
                    
                    const canvas = document.createElement('canvas');
                    imgContainer.appendChild(canvas);
                    
                    // Initial rotation attribute
                    canvas.dataset.rotation = pdfDoc.getPage(i).getRotation().angle;

                    await renderSingleThumbnail(canvas, i);

                    // Selection checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `page-${i}`;
                    checkbox.className = 'absolute top-2 right-2 h-5 w-5 border-gray-300 rounded text-blue-500 focus:ring-blue-400 pointer-events-none'; // Disabled direct interaction initially
                    checkbox.dataset.pageIndex = i;

                    checkbox.addEventListener('change', handleCheckboxChange); // Delegate handling
                    
                    // Rotate buttons for individual pages
                    const rotateControls = document.createElement('div');
                    rotateControls.className = 'flex justify-center space-x-1';
                    
                    const rotateLeftBtn = document.createElement('button');
                    rotateLeftBtn.className = 'p-1 text-gray-500 hover:text-blue-500';
                    rotateLeftBtn.innerHTML = '<i class="fas fa-undo-alt"></i>';
                    rotateLeftBtn.title = 'Rotate counter-clockwise';
                    rotateLeftBtn.dataset.pageIndex = i;
                    rotateLeftBtn.dataset.degrees = '-90';
                    rotateLeftBtn.addEventListener('click', async function(e) {
                        e.stopPropagation(); // Prevent selecting the thumbnail
                        await rotateSinglePage(parseInt(this.dataset.pageIndex), parseInt(this.dataset.degrees));
                    });
                    
                    const rotateRightBtn = document.createElement('button');
                    rotateRightBtn.className = 'p-1 text-gray-500 hover:text-blue-500';
                    rotateRightBtn.innerHTML = '<i class="fas fa-redo-alt"></i>';
                    rotateRightBtn.title = 'Rotate clockwise';
                    rotateRightBtn.dataset.pageIndex = i;
                    rotateRightBtn.dataset.degrees = '90';
                    rotateRightBtn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        await rotateSinglePage(parseInt(this.dataset.pageIndex), parseInt(this.dataset.degrees));
                    });
                    
                    rotateControls.appendChild(rotateLeftBtn);
                    rotateControls.appendChild(rotateRightBtn);
                    
                    // Assemble thumbnail
                    thumbnailDiv.appendChild(pageNumber);
                    thumbnailDiv.appendChild(imgContainer);
                    thumbnailDiv.appendChild(rotateControls);
                    pageContainer.appendChild(thumbnailDiv);
                    pageContainer.appendChild(checkbox);
                    pdfPreview.appendChild(pageContainer);
                    
                    // Clicking anywhere on thumbnail toggles selection
                    pageContainer.addEventListener('click', function(e) {
                        if (!e.target.closest('button')) { // Don't select if clicking rotate buttons
                            const cb = this.querySelector('input[type="checkbox"]');
                            cb.checked = !cb.checked;
                            const event = new Event('change');
                            cb.dispatchEvent(event);
                        }
                    });
                }
                // Update visual selection after render
                 selectedPages.forEach(idx => updatePageSelectionVisual(idx, true));
            }

            async function renderSingleThumbnail(canvas, pageIndex, rotationAngle = null) {
                 try {
                     // Get rotation from pdf-lib document
                     const currentRotation = rotationAngle ?? pdfDoc.getPage(pageIndex).getRotation().angle;
                     canvas.dataset.rotation = currentRotation;

                      const page = await pdfJsDoc.getPage(pageIndex + 1); // pdf.js is 1-based
                      // Use scale = 0.2 for better quality thumbnails within bounds
                     const scale = 0.2;
                      const viewport = page.getViewport({ scale: scale, rotation: currentRotation });
                     const context = canvas.getContext('2d');

                      canvas.height = viewport.height;
                      canvas.width = viewport.width;

                     await page.render({
                         canvasContext: context,
                         viewport: viewport
                     }).promise;
                  } catch (error) {
                     console.error(`Error rendering page ${pageIndex + 1} preview:`, error);
                     const imgContainer = canvas.parentElement;
                     if(imgContainer) {
                       imgContainer.innerHTML = '<i class="fas fa-exclamation-triangle text-red-400" title="Preview failed"></i>';
                     }
                  }
            }

             function handleCheckboxChange(e) {
                 const checkbox = e.target;
                 const pageIndex = parseInt(checkbox.dataset.pageIndex);
                if (checkbox.checked) {
                     if (!selectedPages.includes(pageIndex)) {
                         selectedPages.push(pageIndex);
                     }
                 } else {
                     selectedPages = selectedPages.filter(p => p !== pageIndex);
                 }
                 updatePageSelectionVisual(pageIndex, checkbox.checked);
             }

            function updatePageSelectionVisual(pageIndex, isSelected) {
                const thumbnail = document.querySelector(`.page-thumbnail[data-page-index="${pageIndex}"]`);
                 if (!thumbnail) return; // Ensure thumbnail exists

                 const checkbox = thumbnail.querySelector('input[type="checkbox"]');
                 checkbox.checked = isSelected; // Keep checkbox state synced

                 if (isSelected) {
                     thumbnail.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
                     thumbnail.classList.remove('border-gray-200');
                 } else {
                     thumbnail.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
                     thumbnail.classList.add('border-gray-200');
                 }
             }


            function applyPageRange() {
                const rangeText = pageRangeInput.value.trim();
                if (!pdfDoc || !rangeText) return;
                
                const pageCount = pdfDoc.getPageCount();
                const pagesToSelect = parseRange(rangeText, pageCount);
                
                if (pagesToSelect.length > 0) {
                     clearAllPages(false); // Clear selection without clearing input
                     pagesToSelect.forEach(pageNum => {
                        const pageIndex = pageNum - 1;
                        const checkbox = document.querySelector(`#page-${pageIndex}`);
                        if (checkbox) {
                            checkbox.checked = true;
                            const event = new Event('change');
                            checkbox.dispatchEvent(event);
                        }
                    });
                } else {
                   showError("Invalid page range specified.");
                }
            }

             // Parses range string (e.g., "1, 3, 5-8") into an array of page numbers
             function parseRange(rangeText, maxPages) {
                 const result = new Set(); // Use Set to handle duplicates automatically
                 const parts = rangeText.split(',');

                 for (const part of parts) {
                     const trimmedPart = part.trim();
                     if (trimmedPart.includes('-')) {
                         const [startStr, endStr] = trimmedPart.split('-');
                         const start = parseInt(startStr);
                         const end = parseInt(endStr);

                          if (!isNaN(start) && !isNaN(end) && start >= 1 && end >= start && end <= maxPages) {
                             for (let i = start; i <= end; i++) {
                                result.add(i);
                             }
                          } else {
                             console.warn(`Invalid range format: ${trimmedPart}`);
                              return []; // Return empty if any part is invalid
                         }
                      } else {
                         const num = parseInt(trimmedPart);
                         if (!isNaN(num) && num >= 1 && num <= maxPages) {
                             result.add(num);
                         } else {
                             console.warn(`Invalid page number: ${trimmedPart}`);
                              return []; // Return empty if any part is invalid
                         }
                      }
                 }
                 return Array.from(result).sort((a, b) => a - b); // Convert Set to sorted array
             }


            function selectAllPages() {
                const pageCount = pdfDoc ? pdfDoc.getPageCount() : 0;
                 selectedPages = Array.from({length: pageCount}, (_, i) => i); // Select all indices
                // Update visuals
                for(let i = 0; i < pageCount; i++) {
                    updatePageSelectionVisual(i, true);
                }
                pageRangeInput.value = `1-${pageCount}`;
            }

             function clearAllPages(clearInput = true) {
                 const pageCount = pdfDoc ? pdfDoc.getPageCount() : 0;
                 selectedPages = [];
                 for (let i = 0; i < pageCount; i++) {
                     updatePageSelectionVisual(i, false);
                 }
                 if (clearInput) {
                     pageRangeInput.value = '';
                 }
             }


            async function processRotation() {
                if (!pdfDoc || selectedPages.length === 0 || currentRotation === 0) {
                    showError('Please select pages and a rotation angle first.');
                    return;
                }
                
                 // Disable buttons during processing
                 rotateSelected.disabled = true;
                 rotateSelected.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Rotating...';
                 
                try {
                    const pageIndices = selectedPages.slice(); // Work on a copy

                    for (const pageIndex of pageIndices) {
                         if (pageIndex >= 0 && pageIndex < pdfDoc.getPageCount()) {
                            const page = pdfDoc.getPage(pageIndex);
                            const originalRotation = page.getRotation().angle;
                            page.setRotation(degrees(originalRotation + currentRotation));
                         }
                     }
                    
                     // Save the modified PDF in memory
                     pdfBytes = await pdfDoc.save();
                     
                     // Reload pdf.js doc for accurate previews
                     pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                     
                     // Update only the rotated thumbnails
                     for (const pageIndex of pageIndices) {
                          const canvas = document.querySelector(`.page-thumbnail[data-page-index="${pageIndex}"] canvas`);
                         if (canvas) {
                           await renderSingleThumbnail(canvas, pageIndex);
                         }
                      }
                    
                     // Re-enable button and optionally show success
                     rotateSelected.disabled = false;
                     rotateSelected.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Rotate Selected';
                      // Optionally clear selection and rotation after successful application
                      // clearAllPages();
                      // rotateOptions.forEach(btn => btn.classList.remove('active'));
                      // currentRotation = 0;
                     
                      // Indicate that changes are ready to be saved
                      resultSection.classList.remove('hidden'); // Make download visible


                } catch (error) {
                    console.error('Error rotating PDF pages:', error);
                    showError('Error processing PDF rotations. Please try again.');
                     rotateSelected.disabled = false;
                     rotateSelected.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Rotate Selected';
                }
            }

             // Rotate a single page and update previews immediately
             async function rotateSinglePage(pageIndex, degreesToRotate) { // Renamed parameter for clarity
                 if (!pdfDoc) return;

                 // Disable controls briefly
                  const pageThumb = document.querySelector(`.page-thumbnail[data-page-index="${pageIndex}"]`);
                  const buttons = pageThumb ? pageThumb.querySelectorAll('button') : [];
                  buttons.forEach(btn => btn.disabled = true);

                  try {
                      const page = pdfDoc.getPage(pageIndex);
                      const originalRotation = page.getRotation().angle;
                      page.setRotation(PDFLib.degrees(originalRotation + degreesToRotate)); // Use the parameter

                       // Save the modified PDF in memory
                       pdfBytes = await pdfDoc.save();
                      
                       // Reload pdf.js doc for accurate previews
                       pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                       
                      // Update only the rotated thumbnail
                      const canvas = pageThumb.querySelector('canvas');
                       if (canvas) {
                         await renderSingleThumbnail(canvas, pageIndex);
                       }
                      
                      resultSection.classList.remove('hidden'); // Show download button

                 } catch (error) {
                     console.error('Error rotating single page:', error);
                     showError('Error rotating page. Please try again.');
                 } finally {
                    buttons.forEach(btn => btn.disabled = false); // Re-enable buttons
                }
             }


            function downloadRotatedPDF() {
                if (!pdfBytes || !currentFile) {
                   showError("No processed PDF to download. Please upload and rotate first.");
                   return;
                };
                
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const originalName = currentFile.name.replace(/\.pdf$/i, '');
                saveAs(blob, `${originalName}_rotated.pdf`);
            }

            function resetTool() {
                // Reset UI
                fileInput.value = null; // Clear file input selection
                fileNameDisplay.textContent = '';
                fileNameDisplay.classList.add('hidden');
                controlsSection.classList.add('hidden');
                previewSection.classList.add('hidden');
                resultSection.classList.add('hidden');
                pdfPreview.innerHTML = ''; // Clear thumbnails
                pageRangeInput.value = '';
                rotateOptions.forEach(btn => btn.classList.remove('active'));

                // Reset state
                pdfDoc = null;
                pdfJsDoc = null;
                selectedPages = [];
                currentRotation = 0;
                pdfBytes = null;
                currentFile = null;
            }

            function showError(message) {
                fileError.textContent = message;
                fileError.classList.remove('hidden');
                 // Consider not auto-hiding errors that might be important
                 // setTimeout(() => fileError.classList.add('hidden'), 7000);
            }
        });
    </script>
    <div class="w-full max-w-4xl mx-auto my-8 text-center"> <!-- Centering and margin -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9273434855071552"
             crossorigin="anonymous"></script>
        <!-- Reed -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-9273434855071552"
             data-ad-slot="6257062799"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
</body>
</html>