<!DOCTYPE html>
<html class="light" lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WRM63JPK');</script>
<!-- End Google Tag Manager -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Page Rotator - SmileyPDF</title>
    <link rel="icon" type="image/png" href="logo.png">
     <!-- Base CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {}
        }
    }
</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Additional Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <!-- Redundant but kept from user feedback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
     <!-- AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9273434855071552" crossorigin="anonymous"></script>
    <style>
        .dropzone { transition: all 0.3s ease; }
        .dropzone.active { border-color: #3b82f6; background-color: #f0f7ff; }
        .page-thumbnail { transition: all 0.2s ease; }
        .page-thumbnail:hover { transform: scale(1.03); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .rotate-options button.active { background-color: #3b82f6; color: white; }
        #pdfPreview { max-height: 500px; overflow-y: auto; }
        #pdfPreview::-webkit-scrollbar { width: 8px; }
        #pdfPreview::-webkit-scrollbar-track { background: #f1f1f1; }
        #pdfPreview::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #pdfPreview::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .page-thumbnail.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); } /* Added selection style */
    </style>
<link rel="stylesheet" href="dark-mode.css">
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WRM63JPK"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<!-- Header -->
 <header x-data="{ mobileMenuOpen: false }" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 py-1 flex justify-between items-center">
        <!-- Logo Link -->
        <a href="index.html" class="flex items-center transition duration-150 ease-in-out hover:opacity-80">
           <img src="logo.png" alt="SmileyPDF Logo" class="h-20 w-auto mr-2">
        </a>
        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center space-x-4">
            <a href="index.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Home</a>
            <!-- Tools Dropdown -->
             <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @keydown.escape.window="open = false" class="hover:text-blue-200 font-medium focus:outline-none flex items-center px-3 py-2 rounded-md text-sm">
                    Tools <i class="fas fa-chevron-down ml-1 text-xs"></i>
                </button>
                <div x-show="open" @click.away="open = false"
                     x-transition:enter="transition ease-out duration-100 transform"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75 transform"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20 text-gray-700 py-1 origin-top-right"
                     style="display: none;" x-cloak>
                     <a href="pdf-editor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF Editor</a>
                     <a href="merge-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Merge PDF</a>
                     <a href="image-to-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Image to PDF</a>
                     <a href="pdf-rotator.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Rotate PDF</a>
                     <a href="pdf-text-extractor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Extract PDF Text</a>
                     <a href="pdf-to-jpg.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to JPG</a>
                     <a href="pdf-to-word.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Word</a>
                     <a href="pdf-to-excel.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Excel</a>
                 </div>
             </div>
             <a href="blog.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Blog</a>
             <a href="about.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">About</a>
             <a href="contact.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Contact</a>
         </div>
          <!-- Mobile Menu Button -->
          <div class="flex items-center mr-4">
    <button class="theme-toggle text-white hover:text-blue-200 focus:outline-none" aria-label="Toggle Dark Mode">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 moon-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sun-icon hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
    </button>
</div>
<div class="md:hidden">
              <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white focus:outline-none p-2 rounded hover:bg-blue-600">
                  <span class="sr-only">Open menu</span>
                  <i x-show="!mobileMenuOpen" class="fa-solid fa-bars text-xl"></i>
                  <i x-show="mobileMenuOpen" class="fa-solid fa-times text-xl" style="display: none;" x-cloak></i>
              </button>
         </div>
    </nav>
     <!-- Mobile Menu Panel -->
     <div x-show="mobileMenuOpen"
         @click.away="mobileMenuOpen = false"
         class="md:hidden absolute inset-x-0 top-full bg-blue-600 shadow-lg border-t border-blue-500"
         x-transition:enter="transition ease-out duration-200 transform origin-top"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75 transform origin-top"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         style="display: none;" x-cloak>
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Home</a>
            <a href="blog.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Blog</a>
            <a href="about.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">About</a>
            <a href="contact.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Contact</a>
            <h3 class="px-3 pt-4 pb-1 text-xs font-semibold text-blue-200 uppercase tracking-wider">Tools</h3>
            <a href="pdf-editor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF Editor</a>
            <a href="merge-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Merge PDF</a>
            <a href="image-to-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Image to PDF</a>
            <a href="pdf-rotator.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Rotate PDF</a>
            <a href="pdf-text-extractor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Extract PDF Text</a>
            <a href="pdf-to-jpg.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to JPG</a>
            <a href="pdf-to-word.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Word</a>
            <a href="pdf-to-excel.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Excel</a>
        </div>
     </div>
</header>
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">PDF Page Rotator</h1>
                <p class="text-gray-600">Select individual pages or ranges and rotate them clockwise or counterclockwise. Permanently save the changes to your PDF.</p>
            </div>

            <div class="mb-8">
                <div id="dropzone" class="dropzone border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-400">
                     <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-file-pdf text-5xl text-red-500 mb-4"></i>
                        <p class="text-lg font-medium text-gray-700 mb-2">Drag & drop your PDF file here</p>
                        <p class="text-gray-500 mb-4">or</p>
                        <button type="button" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition cursor-pointer">
                            Select File
                        </button>
                        <input id="fileInput" type="file" accept=".pdf" class="hidden">
                    </div>
                </div>
                <div id="fileNameDisplay" class="mt-2 text-sm text-gray-600 hidden"></div>
                <div id="fileError" class="mt-2 text-sm text-red-500 hidden"></div>
            </div>

            <div id="controlsSection" class="hidden mb-8">
                <div class="bg-gray-100 rounded-lg p-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Rotation Options</h2>
                     <div class="flex flex-wrap items-center gap-4 mb-4">
                        <div class="rotate-options flex gap-2">
                            <button type="button" data-degrees="90" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-redo mr-2"></i>90° Clockwise
                            </button>
                            <button type="button" data-degrees="-90" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-undo mr-2"></i>90° Counter-clockwise
                            </button>
                            <button type="button" data-degrees="180" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-sync-alt mr-2"></i>180°
                            </button>
                        </div>
                    </div>
                     <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center space-x-2 flex-grow">
                            <label for="pageRangeInput" class="text-gray-700">Apply to Pages:</label>
                            <input type="text" id="pageRangeInput" placeholder="e.g. 1, 3, 5-8 or leave blank for all selected" class="border border-gray-300 rounded px-3 py-1 w-full max-w-xs">
                        </div>
                         <div class="flex items-center space-x-2 mt-2 md:mt-0 flex-shrink-0">
                            <button type="button" id="selectAll" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 transition">Select All</button>
                            <button type="button" id="clearSelection" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 transition">Clear Selection</button>
                        </div>
                         <button type="button" id="rotateSelected" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center disabled:opacity-50 mt-2 md:mt-0" disabled>
                             <i class="fas fa-sync-alt mr-2"></i> Rotate
                        </button>
                     </div>
                </div>
            </div>

            <div id="previewSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Page Preview (Click pages to select/deselect)</h2>
                 <div class="mb-4 text-sm text-gray-600 flex justify-between items-center">
                    <div>Total pages: <span id="totalPages" class="font-medium">0</span></div>
                    <div id="selectedCount" class="font-medium text-blue-600">0 pages selected</div>
                </div>
                <div id="pdfPreview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-2 bg-gray-50 rounded-lg border border-gray-200 min-h-[150px]">
                     <p id="previewPlaceholder" class="col-span-full text-center text-gray-500 py-8">Previews will load here...</p>
                </div>
            </div>

            <div id="resultSection" class="hidden mt-8 text-center">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-4">
                    <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-green-800 mb-2">Rotation Applied!</h3>
                    <p class="text-green-600">Your PDF has been updated with the specified rotations. Download the modified file now.</p>
                </div>
                <button id="downloadBtn" type="button" class="px-6 py-3 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition inline-flex items-center">
                    <i class="fas fa-download mr-2"></i> Download Rotated PDF
                </button>
                <button id="newFileBtn" type="button" class="px-6 py-3 ml-4 border border-gray-300 rounded-lg font-medium hover:bg-gray-100 transition inline-flex items-center">
                    <i class="fas fa-redo mr-2"></i> Process Another File
                </button>
            </div>
        </div>

        <!-- How to Use Section -->
        <div class="max-w-4xl mx-auto mt-8 bg-white rounded-xl shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">How to Rotate PDF Pages</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>Upload your PDF using the drag & drop area or the "Select File" button.</li>
                <li>Page previews will appear. Click on the pages you want to rotate to select them (they will get a blue border).</li>
                <li>Use "Select All" or "Clear Selection" buttons for bulk actions.</li>
                <li>Choose a rotation angle (90° clockwise, 90° counter-clockwise, or 180°).</li>
                <li>Optionally, enter specific page numbers or ranges (e.g., `1, 3, 5-8`) in the "Apply to Pages" input. If left blank, rotation applies to all *selected* pages in the preview.</li>
                <li>Click the green "Rotate" button. The previews will update to show the rotation.</li>
                <li>Once satisfied, click "Download Rotated PDF" to save your file.</li>
            </ol>
            <p class="text-center text-sm text-gray-500 mt-4">All processing happens securely in your browser.</p>
        </div>

        <!-- Ad Block -->
         <div class="w-full max-w-4xl mx-auto my-8 text-center">
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9273434855071552" data-ad-slot="6257062799" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div class="mt-8 text-center text-sm text-gray-500">
            <p>This tool uses PDF.js and PDF-Lib for browser-side processing. Your files remain private.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-700 text-gray-300 mt-12 py-8">
        <div class="container mx-auto px-6 text-center">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-sm">
                <div><h4 class="font-semibold mb-2 uppercase">SmileyPDF</h4><p>Free online tools to make your PDF tasks simple and secure.</p></div>
                <div><h4 class="font-semibold mb-2 uppercase">Quick Links</h4><ul><li><a href="index.html" class="hover:text-white">Home</a></li><li><a href="about.html" class="hover:text-white">About Us</a></li><li><a href="blog.html" class="hover:text-white">Blog</a></li><li><a href="contact.html" class="hover:text-white">Contact</a></li></ul></div>
                <div><h4 class="font-semibold mb-2 uppercase">Legal</h4><ul><li><a href="privacy.html" class="hover:text-white">Privacy Policy</a></li><li><a href="terms.html" class="hover:text-white">Terms of Service</a></li></ul></div>
            </div>
            <div class="border-t border-gray-600 pt-6 text-sm">&copy; <span id="current-year"></span> SmileyPDF. All rights reserved.</div>
        </div>
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;

        document.addEventListener('DOMContentLoaded', function() {
             // Lib Check
             let PDFLib, PDFJS;
             if (typeof window.PDFLib === 'undefined' || typeof window.pdfjsLib === 'undefined' || typeof window.saveAs === 'undefined') { showError("Required libraries failed to load. Please refresh.", true); console.error("Missing PDFLib, PDFJS, or FileSaver"); return; }
             PDFLib = window.PDFLib; PDFJS = window.pdfjsLib; const { degrees } = PDFLib;

             // DOM Elements
             const dropzone=document.getElementById('dropzone'), fileInput=document.getElementById('fileInput'), fileNameDisplay=document.getElementById('fileNameDisplay'), fileError=document.getElementById('fileError'), controlsSection=document.getElementById('controlsSection'), previewSection=document.getElementById('previewSection'), resultSection=document.getElementById('resultSection'), pdfPreview=document.getElementById('pdfPreview'), totalPagesDisplay=document.getElementById('totalPages'), rotateOptions=document.querySelectorAll('.rotate-options button'), pageRangeInput=document.getElementById('pageRangeInput'), selectAll=document.getElementById('selectAll'), clearSelection=document.getElementById('clearSelection'), rotateSelected=document.getElementById('rotateSelected'), downloadBtn=document.getElementById('downloadBtn'), newFileBtn=document.getElementById('newFileBtn'), selectedCountDisplay=document.getElementById('selectedCount'), previewPlaceholder = document.getElementById('previewPlaceholder');

            // State variables
             let pdfLibDoc = null, pdfJsDoc = null, selectedPagesIndices = [], currentRotationOption = 0, pdfFileBytes = null, currentFile = null, isProcessing = false;

             // Event Listeners
             setupUploadListeners();
             rotateOptions.forEach(btn => btn.addEventListener('click', handleRotationOptionClick));
             selectAll.addEventListener('click', selectAllPages);
             clearSelection.addEventListener('click', clearPageSelection);
             rotateSelected.addEventListener('click', processRotation);
             downloadBtn.addEventListener('click', downloadRotatedPDF);
             newFileBtn.addEventListener('click', () => resetTool(true));
             pageRangeInput.addEventListener('input', validateAndToggleButtonState);
             pdfPreview.addEventListener('click', handleThumbnailClick); // Delegate click to parent


             function setupUploadListeners() {
                 // Prevent defaults for drag events
                 ['dragenter','dragover','dragleave','drop'].forEach(ev => {
                     dropzone.addEventListener(ev, preventDefaults);
                 });

                 // Prevent defaults on body to avoid browser handling
                 document.body.addEventListener('dragenter', preventDefaults);
                 document.body.addEventListener('dragover', preventDefaults);
                 document.body.addEventListener('drop', preventDefaults);

                 // Add active class for visual feedback
                 ['dragenter','dragover'].forEach(ev => {
                     dropzone.addEventListener(ev, () => dropzone.classList.add('active'));
                 });

                 // Remove active class
                 ['dragleave','drop'].forEach(ev => {
                     dropzone.addEventListener(ev, () => dropzone.classList.remove('active'));
                 });

                 // Handle file drop
                 dropzone.addEventListener('drop', handleDrop);

                 // Handle button click
                 const uploadButton = dropzone.querySelector('button');
                 if (uploadButton) {
                     uploadButton.addEventListener('click', (e) => {
                         e.preventDefault();
                         fileInput.click();
                     });
                 }

                 // Handle file selection
                 fileInput.addEventListener('change', handleFileSelect);
             }
             function preventDefaults(e){e.preventDefault(); e.stopPropagation();}
             function handleDrop(e){
                console.log('File dropped');
                if(isProcessing) {
                    console.log('Processing in progress, ignoring dropped file');
                    return;
                }

                const dt = e.dataTransfer;
                if (!dt || !dt.files || dt.files.length === 0) {
                    console.log('No files in drop event');
                    return;
                }

                const file = dt.files[0];
                console.log('Dropped file:', file.name, file.type);

                handleFileUpload(file);
            }
             function handleFileSelect(e){
                console.log('File selected via input');
                if(isProcessing) {
                    console.log('Processing in progress, ignoring file selection');
                    return;
                }

                const file = e.target.files[0];
                if (!file) {
                    console.log('No file selected');
                    return;
                }

                console.log('Selected file:', file.name, file.type);
                handleFileUpload(file);

                // Reset the file input so the same file can be selected again
                fileInput.value = null;
            }

            async function handleFileUpload(file) {
                console.log('Processing file upload:', file ? file.name : 'no file');

                if (!file || !(file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'))) {
                    showError("Please upload a valid PDF file.", 5000);
                    return;
                }

                resetTool(false);
                isProcessing = true;
                showProcessingMessage('Reading file...');

                try {
                    console.log('Reading file as array buffer');
                    pdfFileBytes = new Uint8Array(await file.arrayBuffer());
                    currentFile = file;
                    showProcessingMessage('Loading PDF...');

                    console.log('Loading PDF with PDF.js and PDF-lib');
                    // Load concurrently
                    [pdfLibDoc, pdfJsDoc] = await Promise.all([
                        PDFLib.PDFDocument.load(pdfFileBytes, { ignoreEncryption: true }),
                        PDFJS.getDocument({ data: pdfFileBytes, cMapUrl: `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS.version}/cmaps/`, cMapPacked: true }).promise
                    ]);

                    console.log('PDF loaded successfully');
                    fileNameDisplay.textContent = `File: ${file.name} (${(file.size / 1024 /1024).toFixed(2)} MB)`;
                    fileNameDisplay.classList.remove('hidden');
                    controlsSection.classList.remove('hidden');
                    previewSection.classList.remove('hidden'); // Show preview section immediately
                     previewPlaceholder.classList.remove('hidden'); // Show loading text
                    pdfPreview.innerHTML = ''; // Clear previous thumbnails if any
                    totalPagesDisplay.textContent = pdfLibDoc.getPageCount(); // Use pdf-lib for count

                    showProcessingMessage(`Rendering ${pdfLibDoc.getPageCount()} page previews...`);
                    await renderAllThumbnails(pdfLibDoc.getPageCount()); // Start rendering
                    selectAllPages(); // Select all by default after rendering

                } catch (error) {
                     console.error("Error loading PDF:", error);
                     showError(`Error loading PDF: ${error.message}. File might be invalid or protected.`, 0); // Persistent error
                     resetTool(true);
                } finally {
                     isProcessing = false; hideProcessingMessage();
                 }
            }

             // Async rendering function remains similar
             async function renderAllThumbnails(pageCount) {
                 previewPlaceholder.classList.add('hidden'); // Hide loading text
                 const promises = [];
                for (let i = 0; i < pageCount; i++) { promises.push(createAndRenderThumbnail(i)); if (i > 0 && i % 10 === 0) { await Promise.all(promises.slice(i-10, i)); await new Promise(r=>setTimeout(r, 1)); } } // Batch rendering
                await Promise.all(promises);
            }
             async function createAndRenderThumbnail(pageIndex) { const pageContainer = document.createElement('div'); pageContainer.className='page-thumbnail bg-white p-2 rounded-md border border-gray-200 cursor-pointer relative'; pageContainer.dataset.pageIndex=pageIndex; const initialRotation = pdfLibDoc?.getPage(pageIndex)?.getRotation()?.angle || 0; pageContainer.innerHTML = `<span class="page-number">${pageIndex+1}</span><div class="canvas-wrapper w-full h-32 bg-gray-100 flex items-center justify-center overflow-hidden mb-2 relative"><div class="absolute inset-0 flex items-center justify-center canvas-loading"><i class="fas fa-spinner fa-spin text-gray-400"></i></div><canvas data-rotation="${initialRotation}"></canvas></div>`; pdfPreview.appendChild(pageContainer); const canvas=pageContainer.querySelector('canvas'); const loading=pageContainer.querySelector('.canvas-loading'); try{await renderSingleThumbnail(canvas, pageIndex); loading?.remove();} catch(e){console.error("Thumb render err:",e); loading.innerHTML='<i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>';} }
             async function renderSingleThumbnail(canvas, pageIndex) { if(!pdfJsDoc) return; const page = await pdfJsDoc.getPage(pageIndex + 1); const currentRotation = parseFloat(canvas.dataset.rotation) || 0; const scale = 0.2; const viewport = page.getViewport({ scale, rotation: currentRotation }); const context = canvas.getContext('2d'); canvas.height = viewport.height; canvas.width = viewport.width; canvas.style.maxWidth='100%'; canvas.style.height='auto'; await page.render({ canvasContext: context, viewport }).promise; }

            // --- Selection & Rotation Logic ---
            function handleRotationOptionClick() { rotateOptions.forEach(btn=>btn.classList.remove('active')); this.classList.add('active'); currentRotationOption = parseInt(this.dataset.degrees); validateAndToggleButtonState(); }
             function handleThumbnailClick(e) { const thumb=e.target.closest('.page-thumbnail'); if(thumb){const pageIdx=parseInt(thumb.dataset.pageIndex); if(!isNaN(pageIdx)) togglePageSelection(pageIdx, thumb);} }
            function togglePageSelection(idx, element) { const arrIdx=selectedPagesIndices.indexOf(idx); if(arrIdx > -1){ selectedPagesIndices.splice(arrIdx, 1); element?.classList.remove('selected');} else { selectedPagesIndices.push(idx); element?.classList.add('selected'); } updateSelectedCount(); validateAndToggleButtonState(); }
            function updateSelectedCount() { selectedCountDisplay.textContent = `${selectedPagesIndices.length} page${selectedPagesIndices.length !== 1 ? 's' : ''} selected`; }
            function selectAllPages() { const count = pdfLibDoc?.getPageCount() ?? 0; selectedPagesIndices = Array.from({length: count}, (_, i)=>i); document.querySelectorAll('.page-thumbnail').forEach(thumb=>thumb.classList.add('selected')); updateSelectedCount(); validateAndToggleButtonState(); }
             function clearPageSelection() { selectedPagesIndices=[]; document.querySelectorAll('.page-thumbnail.selected').forEach(thumb=>thumb.classList.remove('selected')); updateSelectedCount(); validateAndToggleButtonState(); }
            function getIndicesToRotate() { const rangeTxt=pageRangeInput.value.trim(); if(rangeTxt){const parsed=parseRange(rangeTxt,pdfLibDoc?.getPageCount());if(parsed===null){showError("Invalid page range.",5000); return null;} return parsed;} else {return selectedPagesIndices;}}
            function validateAndToggleButtonState() { const canRotate=pdfLibDoc && currentRotationOption !== 0; const indices=getIndicesToRotate(); const isValid = canRotate && indices !== null && indices.length > 0; rotateSelected.disabled = !isValid; return isValid; }
             function parseRange(txt,max) { const res=new Set(); const parts=txt.split(','); try {for(const p of parts){ const t=p.trim(); if(t.includes('-')){ const [s,e]=t.split('-').map(n=>parseInt(n)); if(!isNaN(s)&&!isNaN(e)&&s>=1&&e>=s&&e<=max){for(let i=s;i<=e;i++){res.add(i-1);}}}else{ const n=parseInt(t); if(!isNaN(n)&&n>=1&&n<=max){res.add(n-1);}else{return null;}}} return Array.from(res).sort((a,b)=>a-b); } catch { return null; } }


             async function processRotation() {
                if (isProcessing || !validateAndToggleButtonState()) { showError("Please select rotation and valid pages/range.", 5000); return; }
                const indicesToRotate = getIndicesToRotate(); if (!indicesToRotate || indicesToRotate.length === 0) { showError("No pages specified for rotation.", 5000); return; }

                isProcessing = true; rotateSelected.disabled = true; showProcessingMessage(`Rotating ${indicesToRotate.length} pages...`);

                try {
                     const pages = pdfLibDoc.getPages();
                     for (const index of indicesToRotate) {
                        if (index >= 0 && index < pages.length) {
                             const page = pages[index]; const currentRot = page.getRotation().angle; page.setRotation(degrees((currentRot + currentRotationOption + 360) % 360));
                             const canvas = document.querySelector(`.page-thumbnail[data-page-index="${index}"] canvas`); if (canvas) canvas.dataset.rotation = page.getRotation().angle; // Update canvas rotation attribute for next render
                         }
                    }
                     pdfFileBytes = await pdfLibDoc.save(); // Update bytes
                     pdfJsDoc = await PDFJS.getDocument({ data: pdfFileBytes }).promise; // Reload pdf.js

                     // Update only affected previews
                     const updatePromises = indicesToRotate.map(idx => { const canvas = document.querySelector(`.page-thumbnail[data-page-index="${idx}"] canvas`); return canvas ? renderSingleThumbnail(canvas, idx) : Promise.resolve(); });
                    await Promise.all(updatePromises);

                     resultSection.classList.remove('hidden'); // Show download
                     showSuccessMessage('Rotation applied! Ready to download.', 5000);

                 } catch (error) { handleError(error, "Error applying rotation:"); }
                 finally { isProcessing = false; showProcessingMessage('', true); validateAndToggleButtonState(); } // Hide spinner, re-validate button
             }


            // --- Download & Reset ---
             function downloadRotatedPDF() { if (!pdfFileBytes || !currentFile) { showError("No processed PDF.", 5000); return; } try { const blob=new Blob([pdfFileBytes],{type:'application/pdf'}); const orig=currentFile.name.replace(/\.pdf$/i, ''); saveAs(blob,`${orig}-rotated.pdf`); showSuccessMessage('Download started!', 3000); } catch(err) { console.error("DL Err:", err); showError("Failed to start download."); } }
            function resetTool(showDefaultMsg=true) {
                isProcessing = false;
                currentFile = null;
                pdfLibDoc = null;
                pdfJsDoc = null;
                pdfFileBytes = null;
                selectedPagesIndices = [];
                currentRotationOption = 0;

                // Hide sections
                controlsSection.classList.add('hidden');
                previewSection.classList.add('hidden');
                resultSection.classList.add('hidden');

                // Reset preview
                pdfPreview.innerHTML = '';
                previewPlaceholder.classList.remove('hidden');

                // Reset form elements
                fileInput.value = null;
                fileError.classList.add('hidden');
                hideProcessingMessage();
                rotateOptions.forEach(btn => btn.classList.remove('active'));
                pageRangeInput.value = '';
                rotateSelected.disabled = true;

                // Reset file display
                if (showDefaultMsg) {
                    fileNameDisplay.textContent = '';
                    fileNameDisplay.classList.add('hidden');
                } else {
                    fileNameDisplay.textContent = '';
                }

                updateSelectedCount();
            }

             // --- Utility Functions ---
            function showError(msg, persist=false, duration=5000) {
                const fileError = document.getElementById('fileError');
                if (!fileError) return;

                console.error('Error:', msg);
                fileError.textContent = msg;
                fileError.classList.remove('hidden');

                if (!persist) {
                    setTimeout(() => fileError.classList.add('hidden'), duration);
                }
            }
            function showSuccessMessage(msg, duration=3000) {
                const successMessage = document.getElementById('successMessage');
                const successText = document.getElementById('successText');
                if (!successMessage || !successText) return;

                successText.textContent = msg;
                successMessage.classList.remove('hidden');
                setTimeout(() => successMessage.classList.add('hidden'), duration);
            }
             function showProcessingMessage(msg, hide=false){
                const processingIndicator = document.getElementById('processingIndicator');
                if (!processingIndicator) return;

                if (hide) {
                    processingIndicator.classList.add('hidden');
                } else {
                    const msgSpan = processingIndicator.querySelector('span');
                    if (msgSpan) {
                        msgSpan.textContent = msg || 'Processing...';
                    }
                    processingIndicator.classList.remove('hidden');
                }
            }

            function hideProcessingMessage(){
                const processingIndicator = document.getElementById('processingIndicator');
                if (processingIndicator) {
                    processingIndicator.classList.add('hidden');
                }
            }
             function handleError(err, contextMsg) {
                console.error(contextMsg, err);
                showError(`${contextMsg} ${err.message || 'Please try again.'}`, true);
                isProcessing = false;
                hideProcessingMessage();
                // Reset the tool to allow trying again
                resetTool(false);
            }
         });
    </script>

<script src="dark-mode.js"></script>
</body>
</html>
