<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to PDF Converter</title>
    <!-- Base CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- PDF Libraries -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script> 
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .dropzone {
            border: 2px dashed #6b7280;
            transition: all 0.3s ease;
        }
        .dropzone.active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        .image-preview {
            transition: all 0.3s ease;
        }
        .image-preview:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .progress-bar {
            height: 6px;
            transition: width 0.3s ease;
        }
        .pdf-preview {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        @media (max-width: 640px) {
            .controls {
                flex-direction: column;
                align-items: stretch; /* Ensure controls take full width */
            }
            .controls > div {
                margin-bottom: 0.75rem; /* Add space between controls */
                width: 100%; /* Make each control group take full width */
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
 <!-- Header -->
<!-- Header -->
 <header x-data="{ mobileMenuOpen: false }" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white shadow-md sticky top-0 z-50"> <!-- Blue gradient -->
    <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
        <!-- Logo Link -->
        <a href="index.html" class="flex items-center transition duration-150 ease-in-out hover:opacity-80">
           <img src="logo.png" alt="SmileyPDF Logo" class="h-20 w-auto mr-2"> <!-- UPDATED: h-20 logo size -->
        </a>

        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center space-x-4">
            <a href="index.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Home</a>
            <!-- Tools Dropdown -->
             <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @keydown.escape.window="open = false" class="hover:text-blue-200 font-medium focus:outline-none flex items-center px-3 py-2 rounded-md text-sm">
                    Tools <i class="fas fa-chevron-down ml-1 text-xs"></i>
                </button>
                <div x-show="open" @click.away="open = false"
                     x-transition:enter="transition ease-out duration-100 transform"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75 transform"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20 text-gray-700 py-1 origin-top-right"
                     style="display: none;" x-cloak>
                     <a href="pdf-editor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF Editor</a>
                     <a href="merge-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Merge PDF</a>
                     <a href="image-to-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Image to PDF</a>
                     <a href="pdf-rotator.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Rotate PDF</a>
                     <a href="pdf-text-extractor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Extract PDF Text</a>
                     <a href="pdf-to-jpg.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to JPG</a>
                     <a href="pdf-to-word.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Word</a>
                 </div>
             </div>
         </div>
          <!-- Mobile Menu Button -->
          <div class="md:hidden">
              <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white focus:outline-none p-2 rounded hover:bg-blue-600">
                  <span class="sr-only">Open menu</span>
                  <i x-show="!mobileMenuOpen" class="fa-solid fa-bars text-xl"></i>
                  <i x-show="mobileMenuOpen" class="fa-solid fa-times text-xl" style="display: none;" x-cloak></i>
              </button>
         </div>
    </nav>
     <!-- Mobile Menu Panel -->
     <div x-show="mobileMenuOpen"
         @click.away="mobileMenuOpen = false"
         class="md:hidden absolute inset-x-0 top-full bg-blue-600 shadow-lg border-t border-blue-500"
         x-transition:enter="transition ease-out duration-200 transform origin-top"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75 transform origin-top"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         style="display: none;" x-cloak>
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Home</a>
            <h3 class="px-3 pt-4 pb-1 text-xs font-semibold text-blue-200 uppercase tracking-wider">Tools</h3>
            <a href="pdf-editor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF Editor</a>
            <a href="merge-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Merge PDF</a>
            <a href="image-to-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Image to PDF</a>
            <a href="pdf-rotator.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Rotate PDF</a>
            <a href="pdf-text-extractor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Extract PDF Text</a>
            <a href="pdf-to-jpg.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to JPG</a>
            <a href="pdf-to-word.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Word</a>
        </div>
     </div>
</header>
    <div class="container mx-auto px-4 py-12 max-w-6xl">
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">Image to PDF Converter</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">Upload unlimited images and convert them into a single PDF document</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div id="dropzone" class="dropzone rounded-lg p-8 text-center cursor-pointer mb-6">
                <div class="flex flex-col items-center justify-center space-y-4">
                    <i class="fas fa-cloud-upload-alt text-5xl text-blue-500"></i>
                    <h3 class="text-xl font-semibold text-gray-800">Drag & Drop Images Here</h3>
                    <p class="text-gray-500">or click to browse your files</p>
                    <input type="file" id="fileInput" class="hidden" multiple accept="image/jpeg, image/png, image/webp">
                    <button id="browseBtn" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300">
                        Select Images
                    </button>
                </div>
            </div>

            <div class="w-full bg-gray-200 rounded-full h-2 mb-6 hidden" id="progressContainer">
                <div id="progressBar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
            </div>

            <div id="status" class="text-center text-gray-500 italic mb-6 hidden">
                <i class="fas fa-spinner spinner mr-2"></i>
                <span id="statusText">Processing your images...</span>
            </div>

            <div id="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden" role="alert">
                <p id="errorMessage"></p>
            </div>

            <div class="controls flex flex-wrap justify-between items-center mb-6 gap-4">
                 <div>
                    <label for="orientation" class="block text-sm font-medium text-gray-700 mb-1">Page Orientation</label>
                    <select id="orientation" class="border border-gray-300 rounded-md px-3 py-2">
                        <option value="portrait">Portrait</option>
                        <option value="landscape">Landscape</option>
                    </select>
                </div>
                <div>
                    <label for="margin" class="block text-sm font-medium text-gray-700 mb-1">Margin (mm)</label>
                    <input type="number" id="margin" min="0" max="20" value="5" class="border border-gray-300 rounded-md px-3 py-2 w-20">
                </div>
                <!-- Quality removed as it's less relevant for pdf-lib -->
                <div>
                    <label for="size" class="block text-sm font-medium text-gray-700 mb-1">Page Size</label>
                    <select id="size" class="border border-gray-300 rounded-md px-3 py-2">
                        <option value="A4">A4</option>
                        <option value="Letter">Letter</option>
                        <option value="Legal">Legal</option>
                        <option value="A5">A5</option>
                    </select>
                </div>
            </div>

            <div id="previewContainer" class="hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Selected Images</h3>
                <div id="imagePreviews" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6"></div>
                <div class="flex justify-between items-center">
                    <button id="clearBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-trash-alt mr-2"></i>Clear All
                    </button>
                    <button id="generateBtn" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300 font-medium">
                        <i class="fas fa-file-pdf mr-2"></i>Generate PDF
                    </button>
                </div>
            </div>

            <div id="resultContainer" class="hidden mt-8">
                <div class="flex flex-col md:flex-row items-center justify-between bg-blue-50 p-6 rounded-lg mb-6">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Your PDF is Ready!</h3>
                        <p class="text-gray-600" id="downloadInfo">Click the button below to download your PDF file.</p>
                    </div>
                    <div class="flex space-x-4">
                        <button id="downloadBtn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-300">
                            <i class="fas fa-download mr-2"></i>Download PDF
                        </button>
                        <button id="newPdfBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-plus mr-2"></i>New PDF
                        </button>
                    </div>
                </div>

                <div id="pdfPreviewContainer" class="border border-gray-200 rounded-lg p-4 hidden">
                    <iframe id="pdfPreview" class="w-full h-96 pdf-preview rounded-lg" frameborder="0"></iframe>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 text-center text-gray-600">
            <i class="fas fa-info-circle text-blue-500 text-2xl mb-2"></i>
            <h3 class="font-medium text-gray-700 mb-2">How it works</h3>
            <p class="mb-4">Simply upload multiple images, arrange them in order, and download as a single PDF file.</p>
            <p class="text-sm">No file size limits • Supports JPG, PNG, WEBP • 100% client-side processing</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize variables
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            const previewContainer = document.getElementById('previewContainer');
            const imagePreviews = document.getElementById('imagePreviews');
            const clearBtn = document.getElementById('clearBtn');
            const generateBtn = document.getElementById('generateBtn');
            const resultContainer = document.getElementById('resultContainer');
            const downloadBtn = document.getElementById('downloadBtn');
            const newPdfBtn = document.getElementById('newPdfBtn');
            const error = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const pdfPreviewContainer = document.getElementById('pdfPreviewContainer');
            const pdfPreview = document.getElementById('pdfPreview');

            let files = [];
            let pdfBlob = null;
            // Default settings
            let orientation = 'portrait';
            let margin = 5;
            let pageSizeStr = 'A4';


             // Setup drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropzone.classList.add('active');
            }

            function unhighlight() {
                dropzone.classList.remove('active');
            }

            dropzone.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFiles);
            browseBtn.addEventListener('click', () => fileInput.click());

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const newFiles = dt.files;
                handleFiles({target: {files: newFiles}});
            }

            function handleFiles(e) {
                const newFiles = Array.from(e.target.files);

                if (newFiles.length === 0) return;

                 // Filter only specified image files
                 const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
                 const imageFiles = newFiles.filter(file => allowedTypes.includes(file.type));

                 if (imageFiles.length === 0) {
                    showError('Please upload only JPG, PNG, or WEBP image files.');
                    fileInput.value = ''; // Reset input
                    return;
                }

                 if (imageFiles.length !== newFiles.length) {
                    showError(`Some files were skipped. Only JPG, PNG, and WEBP images are supported.`);
                }

                 // Reset previous state if new files are selected after generating a PDF
                 if (pdfBlob) {
                    files = [];
                    pdfBlob = null;
                    resultContainer.classList.add('hidden');
                    if (pdfPreview.src.startsWith('blob:')) {
                         URL.revokeObjectURL(pdfPreview.src); // Clean up old preview URL
                    }
                 }


                 files = files.concat(imageFiles);
                updatePreviews();
                fileInput.value = ''; // Reset input after handling
            }

            function updatePreviews() {
                imagePreviews.innerHTML = ''; // Clear previous previews

                 files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview relative group rounded-lg overflow-hidden border border-gray-200';

                         preview.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}" class="w-full h-40 object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center">
                                <button class="remove-btn px-3 py-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300" data-index="${index}">
                                    <i class="fas fa-times pointer-events-none"></i> <!-- Make icon non-interactive -->
                                </button>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 truncate">
                                ${file.name}
                            </div>
                            <div class="absolute top-0 left-0 p-1 text-white bg-blue-500 rounded-br-md text-xs">
                                ${index + 1}
                            </div>
                        `;

                         imagePreviews.appendChild(preview);

                         // Add event listener for remove button
                         preview.querySelector('.remove-btn').addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent triggering other potential listeners
                             const indexToRemove = parseInt(event.currentTarget.getAttribute('data-index'));
                            files.splice(indexToRemove, 1);
                            updatePreviews(); // Refresh previews and indices
                        });
                    };
                     reader.onerror = () => {
                        showError(`Failed to read file: ${file.name}`);
                    };
                    reader.readAsDataURL(file);
                });

                 previewContainer.classList.remove('hidden');
                 resultContainer.classList.add('hidden'); // Hide result if showing previews
                error.classList.add('hidden'); // Hide any previous errors
                 generateBtn.disabled = files.length === 0; // Enable/disable based on files
                 generateBtn.innerText = 'Generate PDF';
            }

            clearBtn.addEventListener('click', () => {
                files = [];
                 pdfBlob = null;
                 if (pdfPreview.src.startsWith('blob:')) {
                     URL.revokeObjectURL(pdfPreview.src); // Clean up old preview URL
                }
                updatePreviews(); // Update to show no files
                previewContainer.classList.add('hidden');
                 resultContainer.classList.add('hidden');
            });

            newPdfBtn.addEventListener('click', () => {
                clearBtn.click(); // Same action as clear for now
            });

            generateBtn.addEventListener('click', generatePDF);

            // Function to convert mm to points (1mm = 2.83465 points)
            function mmToPoints(mm) {
                return mm * 2.83464566929;
            }
            

            async function generatePDF() {
                if (files.length === 0) {
                    showError('Please upload at least one image');
                    return;
                }

                 showStatus('Preparing PDF...');
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                 generateBtn.disabled = true;
                 generateBtn.innerHTML = '<i class="fas fa-spinner spinner mr-2"></i>Generating...';
                clearBtn.disabled = true; // Disable while processing


                 // Get options
                 orientation = document.getElementById('orientation').value; // portrait or landscape
                 margin = mmToPoints(parseInt(document.getElementById('margin').value) || 0); // Convert mm to points
                 pageSizeStr = document.getElementById('size').value; // A4, Letter, etc. (string)
                 
                 // Use setTimeout to allow UI to update
                setTimeout(async () => {
                    try {
                        const { PDFDocument, PageSizes, StandardFonts, rgb, RotationTypes } = window.PDFLib; // Use uppercase PDFLib
                        const pdfDoc = await PDFDocument.create();

                        // Function to get PDFLib Page Size enum (moved inside generatePDF scope)
                        function getPdfLibPageSize(sizeStr) {
                            switch (sizeStr.toUpperCase()) {
                                case 'LETTER': return PageSizes.Letter;
                                case 'LEGAL': return PageSizes.Legal;
                                case 'A5': return PageSizes.A5;
                                case 'A4':
                                default: return PageSizes.A4;
                            }
                        }
                        let processed = 0;
                        
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            showStatus(`Processing image ${i + 1} of ${files.length}: ${file.name}`);
                             try {
                                const imageBytes = await file.arrayBuffer();
                                let embeddedImage;
                                
                                if (file.type === 'image/png') {
                                    embeddedImage = await pdfDoc.embedPng(imageBytes);
                                } else if (file.type === 'image/jpeg') {
                                    embeddedImage = await pdfDoc.embedJpg(imageBytes);
                                } else if (file.type === 'image/webp') {
                                     // Convert WEBP via canvas
                                    const dataUrl = await fileToDataUrl(file);
                                    const img = await loadImageFromDataUrl(dataUrl);
                                    const tempCanvas = document.createElement('canvas');
                                    tempCanvas.width = img.naturalWidth;
                                    tempCanvas.height = img.naturalHeight;
                                    const ctx = tempCanvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0);
                                    const jpgDataUri = tempCanvas.toDataURL('image/jpeg', 0.9); // Convert to JPEG for embedding
                                    const jpgBytes = await fetch(jpgDataUri).then(res => res.arrayBuffer());
                                    embeddedImage = await pdfDoc.embedJpg(jpgBytes);
                                 } else {
                                    console.warn(`Unsupported image type: ${file.type}. Skipping file ${file.name}.`);
                                     throw new Error(`Unsupported type: ${file.type}`);
                                 }
                                
                                const pageSize = getPdfLibPageSize(pageSizeStr); // Get dimensions array [width, height]
                                
                                // Adjust page size based on orientation and image aspect ratio
                                const imgDims = embeddedImage.scale(1);
                                let pageW = pageSize[0];
                                let pageH = pageSize[1];

                                // Swap if landscape is selected AND page format is portrait naturally (W < H)
                                if (orientation === 'landscape' && pageW < pageH) {
                                     [pageW, pageH] = [pageH, pageW]; 
                                 }
                                 // Swap if portrait is selected AND page format is landscape naturally (W > H)
                                 else if (orientation === 'portrait' && pageW > pageH) {
                                    [pageH, pageW] = [pageW, pageH];
                                 }

                                 const page = pdfDoc.addPage([pageW, pageH]);

                                 const { width: currentPageWidth, height: currentPageHeight } = page.getSize(); // Use dimensions from added page
                                 const usableWidth = currentPageWidth - (margin * 2);
                                 const usableHeight = currentPageHeight - (margin * 2);
 
                                 // Calculate scaling
                                 const widthScale = usableWidth / imgDims.width;
                                 const heightScale = usableHeight / imgDims.height;
                                 const scale = Math.min(widthScale, heightScale);
 
                                 const scaledWidth = imgDims.width * scale;
                                 const scaledHeight = imgDims.height * scale;
 
                                 if (!isFinite(scaledWidth) || !isFinite(scaledHeight) || scaledWidth <= 0 || scaledHeight <= 0) {
                                    throw new Error("Calculated invalid dimensions for drawing.");
                                }

                                 // Center image
                                 const x = margin + (usableWidth - scaledWidth) / 2;
                                 const y = currentPageHeight - margin - scaledHeight - (usableHeight - scaledHeight) / 2; // pdf-lib y is from bottom

                                page.drawImage(embeddedImage, {
                                    x: x,
                                    y: y,
                                    width: scaledWidth,
                                    height: scaledHeight,
                                });

                            } catch (imgErr) {
                                console.error(`Skipping image ${file.name} due to error:`, imgErr);
                                showError(`Could not process image: ${file.name}. Error: ${imgErr.message}. Skipping.`);
                           } finally {
                               processed++;
                               const progress = Math.round((processed / files.length) * 100);
                               progressBar.style.width = `${progress}%`;
                           }
                           
                           // Optional delay
                            if (processed % 5 === 0) {
                                await new Promise(resolve => setTimeout(resolve, 20));
                           }
                        }
                        
                        showStatus('Saving PDF...');
                        const pdfBytes = await pdfDoc.save();
                        pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                        showResult(pdfBlob);

                    } catch (err) {
                        showError('Error generating PDF: ' + err.message);
                        console.error(err);
                    } finally {
                        hideStatus();
                        generateBtn.disabled = files.length === 0;
                         generateBtn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Generate PDF';
                        clearBtn.disabled = false;
                    }
                }, 50); // Short delay for UI update
            }
            
             // Helper function to read file as Data URL
             function fileToDataUrl(file) {
                 return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(reader.error);
                    reader.readAsDataURL(file);
                 });
             }

              // Helper function to load an Image object from various sources
              function loadImageFromDataUrl(src) { // src can be Data URL or Object URL
                 return new Promise((resolve, reject) => {
                     const img = new Image();
                     img.onload = () => {
                         // Validate natural dimensions *before* resolving
                         if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                            resolve(img);
                         } else {
                             const errMsg = `Image loaded with invalid natural dimensions: [${img.naturalWidth}, ${img.naturalHeight}]`;
                             console.error(errMsg, "Source:", src.substring(0,100) + "..."); // Log part of source
                             reject(new Error(errMsg));
                         }
                     };
                      img.onerror = (e) => {
                         console.error("loadImageFromDataUrl Error Event:", e, "Source:", src.substring(0, 100) + "...");
                         reject(new Error("Failed to load image"));
                      };
                     img.src = src;
                  });
              }


            function showResult(blob) {
                 resultContainer.classList.remove('hidden');
                 previewContainer.classList.add('hidden'); // Hide previews
                progressContainer.classList.add('hidden');
                 hideStatus(); // Hide processing status

                 let pdfUrl = null; // Keep URL reference for revocation

                 downloadBtn.onclick = function() {
                     if (pdfUrl) URL.revokeObjectURL(pdfUrl); // Revoke previous if exists
                     pdfUrl = URL.createObjectURL(blob); // Create fresh URL

                     const a = document.createElement('a');
                     a.href = pdfUrl;
                     a.download = 'smileyPDF_image_to_pdf.pdf';
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);

                     // Note: Do not revoke immediately, allow browser time to initiate download
                      setTimeout(() => {
                        if(pdfUrl) URL.revokeObjectURL(pdfUrl);
                        pdfUrl = null; // Clear reference after potential use
                    }, 60000); // Revoke after 1 minute
                 };

                  // Handle Preview (create new URL each time)
                  const previewUrl = URL.createObjectURL(blob);
                  try {
                     pdfPreview.src = previewUrl;
                      pdfPreviewContainer.classList.remove('hidden');
                  } catch (e) {
                     pdfPreviewContainer.classList.add('hidden');
                     console.log('PDF preview might not be available in this browser/context.');
                 }
                 // Do not revoke previewUrl immediately, needed for iframe
             }


            function showError(message) {
                 errorMessage.textContent = message;
                 error.classList.remove('hidden');
                 hideStatus(); // Ensure status is hidden on error
                 progressContainer.classList.add('hidden');
                 generateBtn.disabled = files.length === 0; // Re-enable generate button based on files
                 generateBtn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Generate PDF';
                clearBtn.disabled = false;
                 // Optionally hide error message after some time
                 // setTimeout(() => { error.classList.add('hidden'); }, 5000);
             }

            function showStatus(message) {
                 statusText.textContent = message;
                 status.classList.remove('hidden');
                 // progressContainer should be visible if status is shown
                 progressContainer.classList.remove('hidden');
             }

            function hideStatus() {
                 status.classList.add('hidden');
             }


        });
    </script>
     <!-- Ad Block -->
    <div class="w-full max-w-4xl mx-auto my-8 text-center">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9273434855071552"
             crossorigin="anonymous"></script>
        <!-- Reed -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-9273434855071552"
             data-ad-slot="6257062799"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
</body>
</html>
