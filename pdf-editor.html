<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PDF Editor - SmileyPDF</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9273434855071552" crossorigin="anonymous"></script>
    <!-- Google Fonts for Signature -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Brush+Script+MT&family=Dancing+Script&family=Lucida+Handwriting&family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <style>
        /* Base styles */
        body {
             overflow-y: scroll; /* Ensure scrollbar is always present */
        }
         #pdf-render { border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); margin: 0 auto; position: relative; overflow: hidden; /* Prevents annotations going outside on zoom */ }
         .canvas-container { position: relative; margin: 0 auto; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }

        /* Annotation styles */
         .annotation { position: absolute; cursor: move; /* Move cursor for dragging */ resize: both; /* Enable resize handles */ overflow: visible; min-width: 20px; min-height: 20px; border: 1px dashed transparent; z-index: 5; /* Above canvas, below panels */ transition: border-color 0.2s, background-color 0.2s; }
         .annotation:hover { border-color: #4F46E5; /* Indigo 600 */ }
         .annotation.selected { border: 1px solid #4F46E5; background-color: rgba(79, 70, 229, 0.1); }
        /* Delete button on annotation hover */
         .delete-btn { position: absolute; top: -10px; /* Adjust position */ right: -10px; width: 20px; /* Size */ height: 20px; background-color: #EF4444; /* Red 500 */ border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; z-index: 10; /* Above annotation */ opacity: 0; /* Hidden by default */ transition: opacity 0.2s; pointer-events: auto; /* Allow clicking */ }
         .annotation:hover .delete-btn { opacity: 1; }
         /* Resize handle (simple bottom-right) */
         .annotation::after { content: ''; position: absolute; bottom: -5px; right: -5px; width: 10px; height: 10px; background: #4F46E5; border: 1px solid white; border-radius: 50%; cursor: nwse-resize; opacity: 0; transition: opacity 0.2s; z-index: 11; }
         .annotation.selected::after { opacity: 1; } /* Show only when selected */
         /* Text specific annotation style */
         .editable-text { min-height: 20px; width: 100%; height: 100%; outline: none; padding: 2px 4px; /* Added padding */ cursor: text; box-sizing: border-box; /* Include padding/border in size */ overflow-wrap: break-word; word-wrap: break-word; white-space: pre-wrap; line-height: 1.2; font-size: inherit; /* Inherit from parent annotation properties */ font-family: inherit; }

        /* Signature pad styles */
         #signature-pad { border: 1px solid #e5e7eb; background-color: white; touch-action: none; /* Important for mobile drawing */ width: 100%; height: 150px; border-radius: 4px; }

        /* Tool panel styles */
         .tool-panel { position: absolute; /* Positioned relative to main content area */ left: 70px; /* Position next to toolbar */ top: 10px; /* Align with top tool */ background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 10px 15px; z-index: 100; width: 260px; /* Slightly wider */ display: none; } /* Hidden by default */
         /* Style controls inside panels */
         .tool-panel label { display: block; margin-bottom: 4px; font-size: 12px; color: #4b5563; font-weight: 500; }
         .tool-panel input[type="number"], .tool-panel input[type="range"], .tool-panel select, .tool-panel input[type="text"] { width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; margin-bottom: 10px; box-sizing: border-box; }
         .tool-panel button { padding: 6px 12px; border-radius: 4px; font-size: 13px; transition: background-color 0.2s; cursor: pointer; border: 1px solid transparent; } /* Added base border */
         .color-grid { display: flex; flex-wrap: wrap; margin-bottom: 10px; }
         .color-option { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; margin: 3px; border: 2px solid transparent; transition: transform 0.1s, border-color 0.1s; }
         .color-option.selected { border-color: #4F46E5; transform: scale(1.15); box-shadow: 0 0 0 2px white; }
         .font-option { padding: 5px 10px; margin: 2px 0; cursor: pointer; border-radius: 4px; display: block; font-size: 14px; transition: background-color 0.2s; }
         .font-option.selected, .font-option:hover { background-color: #E5E7EB; /* Gray 200 */ }
         .font-option.selected { font-weight: bold; }
        /* Style tool formatting buttons */
         .format-button { padding: 0.3rem 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background-color: white; }
         .format-button.active { background-color: #dbeafe; border-color: #60a5fa; } /* Light blue bg, blue border */
         .format-button:hover { background-color: #f3f4f6; }


        /* Tooltip style */
         .tooltip-text { position: absolute; left: 60px; top: 50%; transform: translateY(-50%); background-color: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; opacity: 0; transition: opacity 0.2s; pointer-events: none; white-space: nowrap; z-index: 1000; }
         .group:hover .tooltip-text { opacity: 1; }

        /* Signature/Image Specifics */
         #signature-type-container { margin-top: 10px; }
         #image-drop-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.2s, background-color 0.2s; margin-top: 10px; color: #6b7280; }
         #image-drop-zone:hover, #image-drop-zone.dragover { border-color: #4F46E5; background-color: rgba(79, 70, 229, 0.05); }
         #file-input, #image-input { display: none; }
         #initials-text, #signature-text { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 5px; display: none; /* Hidden initially */}
         #signature-text { font-family: 'Brush Script MT', cursive; font-size: 24px;} /* Default font */
         #initials-text { font-family: 'Brush Script MT', cursive; font-size: 32px; }
         .active-tool { background-color: #4F46E5 !important; color: white !important; }


        /* Responsive adjustments (optional) */
         @media (max-width: 768px) {
             .tool-panel { left: 10px; width: calc(100% - 20px); max-width: 300px; }
             /* Further mobile adjustments if needed */
         }
    </style>
</head>
<body class="bg-gray-100 font-sans">
<!-- Header (Same as index.html) -->
<header x-data="{ mobileMenuOpen: false }" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 py-1 flex justify-between items-center">
        <!-- Logo Link -->
        <a href="index.html" class="flex items-center transition duration-150 ease-in-out hover:opacity-80">
           <img src="logo.png" alt="SmileyPDF Logo" class="h-20 w-auto mr-2">
        </a>
        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center space-x-4">
            <a href="index.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Home</a>
            <!-- Tools Dropdown -->
             <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @keydown.escape.window="open = false" class="hover:text-blue-200 font-medium focus:outline-none flex items-center px-3 py-2 rounded-md text-sm">
                    Tools <i class="fas fa-chevron-down ml-1 text-xs"></i>
                </button>
                <div x-show="open" @click.away="open = false"
                     x-transition:enter="transition ease-out duration-100 transform"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75 transform"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20 text-gray-700 py-1 origin-top-right"
                     style="display: none;" x-cloak>
                     <a href="pdf-editor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF Editor</a>
                     <a href="merge-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Merge PDF</a>
                     <a href="image-to-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Image to PDF</a>
                     <a href="pdf-rotator.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Rotate PDF</a>
                     <a href="pdf-text-extractor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Extract PDF Text</a>
                     <a href="pdf-to-jpg.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to JPG</a>
                     <a href="pdf-to-word.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Word</a>
                     <a href="pdf-to-excel.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Excel</a>
                 </div>
             </div>
             <a href="blog.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Blog</a>
             <a href="about.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">About</a>
             <a href="contact.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Contact</a>
         </div>
          <!-- Mobile Menu Button -->
          <div class="md:hidden">
              <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white focus:outline-none p-2 rounded hover:bg-blue-600">
                  <span class="sr-only">Open menu</span>
                  <i x-show="!mobileMenuOpen" class="fa-solid fa-bars text-xl"></i>
                  <i x-show="mobileMenuOpen" class="fa-solid fa-times text-xl" style="display: none;" x-cloak></i>
              </button>
         </div>
    </nav>
     <!-- Mobile Menu Panel -->
     <div x-show="mobileMenuOpen"
         @click.away="mobileMenuOpen = false"
         class="md:hidden absolute inset-x-0 top-full bg-blue-600 shadow-lg border-t border-blue-500"
         x-transition:enter="transition ease-out duration-200 transform origin-top"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75 transform origin-top"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         style="display: none;" x-cloak>
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Home</a>
            <a href="blog.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Blog</a>
            <a href="about.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">About</a>
            <a href="contact.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Contact</a>
            <h3 class="px-3 pt-4 pb-1 text-xs font-semibold text-blue-200 uppercase tracking-wider">Tools</h3>
            <a href="pdf-editor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF Editor</a>
            <a href="merge-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Merge PDF</a>
            <a href="image-to-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Image to PDF</a>
            <a href="pdf-rotator.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Rotate PDF</a>
            <a href="pdf-text-extractor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Extract PDF Text</a>
            <a href="pdf-to-jpg.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to JPG</a>
            <a href="pdf-to-word.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Word</a>
            <a href="pdf-to-excel.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Excel</a>
        </div>
     </div>
</header>

    <!-- Introductory Text -->
    <div class="container mx-auto px-6 pt-8 pb-4 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Online PDF Editor</h1>
        <p class="text-gray-600">Add text, images, signatures, and highlights to your PDF documents easily and for free. All processing is done securely in your browser.</p>
    </div>

    <!-- Main Editor Interface -->
     <div class="flex h-[calc(100vh-180px)] md:h-[calc(100vh-128px)] overflow-hidden relative"> <!-- Adjust height, more reduction on smaller screens for intro text -->
        <!-- Left Toolbar -->
        <div class="w-16 bg-white shadow-md flex flex-col items-center py-4 space-y-6 flex-shrink-0 z-20"> <!-- Toolbar above panels -->
            <!-- Upload PDF Button -->
            <div class="group relative">
                <button id="upload-btn" title="Upload PDF" class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-file-upload text-gray-700 text-lg"></i>
                </button>
                <input type="file" id="file-input" accept=".pdf">
                <span class="tooltip-text">Upload PDF</span>
            </div>
            <!-- Tool Buttons -->
             <div class="group relative"><button id="text-tool" title="Add Text" class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><i class="fas fa-font text-gray-700 text-lg"></i></button><span class="tooltip-text">Text Tool</span></div>
             <div class="group relative"><button id="signature-tool" title="Add Signature/Initials" class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><i class="fas fa-signature text-gray-700 text-lg"></i></button><span class="tooltip-text">Signature/Initials</span></div>
             <div class="group relative"><button id="image-tool" title="Add Image" class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><i class="fas fa-image text-gray-700 text-lg"></i></button><span class="tooltip-text">Image Tool</span></div>
             <div class="group relative"><button id="highlight-tool" title="Highlight Area" class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><i class="fas fa-highlighter text-gray-700 text-lg"></i></button><span class="tooltip-text">Highlight Area</span></div>
            <!-- Save Button at bottom -->
             <div class="group relative mt-auto"><button id="save-pdf" title="Save Edited PDF" class="w-12 h-12 rounded-lg flex items-center justify-center bg-blue-600 hover:bg-blue-700 transition text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fas fa-save text-lg"></i></button><span class="tooltip-text">Save PDF</span></div>
        </div>

        <!-- Main Content Area (includes viewer and tool panels relative to this) -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
             <!-- Top Bar for page navigation/zoom -->
             <div class="bg-white shadow-sm py-2 px-4 flex items-center justify-between border-b border-gray-200 flex-shrink-0">
                 <h1 id="pdf-filename" class="text-base md:text-lg font-semibold text-gray-800 truncate max-w-[150px] md:max-w-xs" title="No PDF Loaded">PDF Editor Tool</h1>
                 <div class="flex items-center space-x-1 md:space-x-3">
                     <div class="flex items-center">
                         <label for="page-select" class="text-gray-600 mr-1 text-xs md:text-sm hidden sm:inline">Page:</label>
                         <select id="page-select" class="border rounded px-1 md:px-2 py-0.5 md:py-1 text-xs md:text-sm" disabled>
                             <option>N/A</option>
                         </select>
                         <span id="page-count" class="text-gray-500 text-xs md:text-sm ml-1"></span>
                     </div>
                     <button id="zoom-out" title="Zoom Out" class="w-7 h-7 md:w-8 md:h-8 rounded flex items-center justify-center hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fas fa-search-minus text-gray-600 text-sm md:text-base"></i></button>
                     <span id="zoom-level" class="text-xs md:text-sm text-gray-700 w-10 text-center">100%</span>
                     <button id="zoom-in" title="Zoom In" class="w-7 h-7 md:w-8 md:h-8 rounded flex items-center justify-center hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fas fa-search-plus text-gray-600 text-sm md:text-base"></i></button>
                 </div>
             </div>
             <!-- PDF Viewer Area -->
             <div class="flex-1 overflow-auto p-4 md:p-6 bg-gray-50 relative" id="pdf-viewer"> <!-- Relative for canvas container -->
                <div id="pdf-container" class="relative mx-auto w-max"> <!-- Container for canvas and annotations -->
                     <div id="pdf-render" class="canvas-container"> <!-- Add positioning for spinner -->
                         <canvas id="pdf-canvas"></canvas>
                         <!-- Spinner for loading/rendering -->
                        <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-50 hidden">
                             <i class="fas fa-spinner fa-spin text-blue-600 text-4xl"></i>
                        </div>
                     </div>
                     {/* Annotations will be appended here by JS */}
                </div>
             </div>

            <!-- TOOL PANELS (Positioned Absolutely within Main Content) -->
            <!-- Text Tool Panel -->
            <div id="text-tool-panel" class="tool-panel">
                <label class="mb-1">Font Family</label>
                <div class="mb-2">
                    <div class="font-option selected" style="font-family: Arial, sans-serif;" data-font="Arial, sans-serif">Arial</div>
                    <div class="font-option" style="font-family: 'Times New Roman', Times, serif;" data-font="'Times New Roman', Times, serif">Times New Roman</div>
                    <div class="font-option" style="font-family: 'Courier New', Courier, monospace;" data-font="'Courier New', Courier, monospace">Courier New</div>
                    <div class="font-option" style="font-family: Verdana, sans-serif;" data-font="Verdana, sans-serif">Verdana</div>
                    <div class="font-option" style="font-family: Georgia, serif;" data-font="Georgia, serif">Georgia</div>
                    <div class="font-option" style="font-family: 'Comic Sans MS', cursive, sans-serif;" data-font="'Comic Sans MS', cursive, sans-serif">Comic Sans</div> {/* Added more standard fonts */}
                </div>
                 <div class="grid grid-cols-2 gap-x-4 items-center mb-2">
                    <div>
                        <label for="text-size" class="mb-1">Size</label>
                        <input type="number" id="text-size" value="14" min="8" max="96" step="2" class="w-full"> {/* Increased max, step 2 */}
                    </div>
                    <div class="flex space-x-1 mt-4">
                         <button id="bold-text" title="Bold" class="format-button"><i class="fas fa-bold"></i></button>
                         <button id="italic-text" title="Italic" class="format-button"><i class="fas fa-italic"></i></button>
                         <button id="underline-text" title="Underline" class="format-button"><i class="fas fa-underline"></i></button>
                    </div>
                </div>
                <label class="mb-1">Color</label>
                <div class="color-grid">
                    <div class="color-option selected" style="background-color: #000000;" data-color="black" title="Black" onclick="setCurrentTextProperty('color', 'black')"></div>
                    <div class="color-option" style="background-color: #EF4444;" data-color="red" title="Red" onclick="setCurrentTextProperty('color', 'red')"></div>
                    <div class="color-option" style="background-color: #3B82F6;" data-color="blue" title="Blue" onclick="setCurrentTextProperty('color', 'blue')"></div>
                    <div class="color-option" style="background-color: #10B981;" data-color="green" title="Green" onclick="setCurrentTextProperty('color', 'green')"></div>
                    <div class="color-option" style="background-color: #8B5CF6;" data-color="purple" title="Purple" onclick="setCurrentTextProperty('color', 'purple')"></div>
                    <div class="color-option" style="background-color: #F59E0B;" data-color="orange" title="Orange" onclick="setCurrentTextProperty('color', 'orange')"></div> {/* Added Orange */}
                    <div class="color-option" style="background-color: #6B7280;" data-color="gray" title="Gray" onclick="setCurrentTextProperty('color', 'gray')"></div>
                    <div class="color-option" style="background-color: #ffffff; border: 1px solid #ccc" data-color="white" title="White" onclick="setCurrentTextProperty('color', 'white')"></div> {/* Added White */}
                </div>
            </div>

            <!-- Signature Tool Panel -->
            <div id="signature-tool-panel" class="tool-panel">
                 <div class="flex space-x-2 mb-3">
                     <button id="draw-signature" class="flex-1 bg-blue-600 text-white py-1" title="Draw Signature">Draw</button>
                     <button id="type-signature" class="flex-1 bg-gray-100 py-1 border border-gray-300" title="Type Signature">Type</button>
                     <button id="initials-btn" class="flex-1 bg-gray-100 py-1 border border-gray-300" title="Type Initials">Initials</button>
                 </div>

                <!-- Drawing Section -->
                <div id="signature-draw-container">
                     <canvas id="signature-pad"></canvas>
                     <label class="mt-2 mb-1">Pen Color</label>
                     <div class="color-grid mb-2">
                         <div class="color-option selected" style="background-color: #000000;" data-color="black" title="Black" onclick="setSignatureColor('black')"></div>
                         <div class="color-option" style="background-color: #3B82F6;" data-color="blue" title="Blue" onclick="setSignatureColor('blue')"></div>
                         <div class="color-option" style="background-color: #EF4444;" data-color="red" title="Red" onclick="setSignatureColor('red')"></div>
                     </div>
                </div>

                 <!-- Typing Section -->
                <div id="signature-type-container" class="hidden">
                    <input type="text" id="signature-text" placeholder="Type your signature">
                    <input type="text" id="initials-text" placeholder="Type initials" maxlength="5">
                    <label class="mt-2 mb-1">Font</label>
                    <select id="signature-font" class="mb-2">
                        <option style="font-family: 'Pacifico', cursive;" value="Pacifico, cursive">Pacifico</option>
                        <option style="font-family: 'Dancing Script', cursive;" value="'Dancing Script', cursive">Dancing Script</option>
                        <option style="font-family: 'Brush Script MT', cursive;" value="'Brush Script MT', cursive">Brush Script</option>
                        <option style="font-family: 'Lucida Handwriting', cursive;" value="'Lucida Handwriting', cursive">Lucida Handwriting</option>
                        <option style="font-family: 'Arial', sans-serif;" value="Arial, sans-serif">Arial</option> {/* Simple option */}
                    </select>
                     <label class="mb-1">Text Color</label>
                    <div class="color-grid mb-2">
                         <div class="color-option selected" style="background-color: #000000;" data-color="black" title="Black" onclick="setTypedSignatureColor('black')"></div>
                         <div class="color-option" style="background-color: #3B82F6;" data-color="blue" title="Blue" onclick="setTypedSignatureColor('blue')"></div>
                         <div class="color-option" style="background-color: #EF4444;" data-color="red" title="Red" onclick="setTypedSignatureColor('red')"></div>
                    </div>
                 </div>
                <div class="flex justify-between mt-2">
                    <button id="clear-signature" class="bg-gray-200 hover:bg-gray-300 text-gray-700" title="Clear">Clear</button>
                    <button id="save-signature" class="bg-blue-600 hover:bg-blue-700 text-white" title="Add to PDF">Add</button>
                </div>
            </div>

             <!-- Image Tool Panel -->
            <div id="image-tool-panel" class="tool-panel">
                 <div id="image-drop-zone">
                    <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-gray-400"></i>
                     <p>Drag & drop image or <button id="browse-images" class="text-blue-600 hover:underline focus:outline-none">browse</button></p>
                    <input type="file" id="image-input" accept="image/png, image/jpeg, image/gif, image/webp">
                 </div>
                 <p class="text-xs text-gray-500 mt-1 text-center">Supports PNG, JPG, GIF, WEBP</p>
            </div>

            <!-- Highlight Tool Panel -->
            <div id="highlight-tool-panel" class="tool-panel">
                <label class="mb-1">Highlight Color</label>
                 <div class="color-grid mb-2">
                     <div class="color-option selected" data-color="yellow" title="Yellow" onclick="setCurrentHighlightProperty('color', 'yellow')"></div>
                     <div class="color-option" data-color="green" title="Green" onclick="setCurrentHighlightProperty('color', 'green')"></div>
                     <div class="color-option" data-color="blue" title="Blue" onclick="setCurrentHighlightProperty('color', 'blue')"></div>
                     <div class="color-option" data-color="pink" title="Pink" onclick="setCurrentHighlightProperty('color', 'pink')"></div>
                     <div class="color-option" data-color="purple" title="Purple" onclick="setCurrentHighlightProperty('color', 'purple')"></div>
                 </div>
                 <label for="highlight-opacity">Opacity (<span id="opacity-value">50</span>%)</label>
                 <input type="range" id="highlight-opacity" min="10" max="80" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
            </div>

        </div>
    </div>

    <!-- How to Use Section (Improved with Icons) -->
    <div class="container mx-auto px-6 py-8">
         <div class="bg-white p-6 rounded-lg shadow-md">
             <h2 class="text-2xl font-semibold text-gray-800 mb-4">How to Use the PDF Editor</h2>
             <ol class="list-decimal list-inside space-y-2 text-gray-700">
                 <li>Click <i class="fas fa-file-upload text-blue-600 mx-1"></i> to upload your PDF, or simply drag and drop it onto the main area.</li>
                 <li>Select a tool from the left toolbar: <i class="fas fa-font text-blue-600 mx-1"></i> (Text), <i class="fas fa-signature text-blue-600 mx-1"></i> (Signature), <i class="fas fa-image text-blue-600 mx-1"></i> (Image), or <i class="fas fa-highlighter text-blue-600 mx-1"></i> (Highlight Area).</li>
                 <li>Click on the PDF page to add text, signatures, or images. For highlighting, click and drag over the desired area.</li>
                 <li>Use the floating tool panel to customize properties (font, color, size, opacity, etc.).</li>
                 <li>Click and drag elements to move them. Use the corner handle <span class="inline-block border border-blue-400 bg-white rounded-full w-3 h-3 cursor-nwse-resize -ml-1 -mb-1 relative" style="bottom:-2px; right:-2px;"></span> to resize.</li>
                 <li>Hover over an element and click the red <span class="text-red-500 font-bold inline-block bg-white border border-red-300 rounded-full w-4 h-4 leading-tight text-center text-xs cursor-pointer">&times;</span> button to delete it.</li>
                 <li>Navigate between pages using the page selector at the top-right. Zoom using <i class="fas fa-search-plus mx-1"></i> / <i class="fas fa-search-minus mx-1"></i> buttons.</li>
                 <li>When finished editing, click the blue <i class="fas fa-save text-blue-600 mx-1"></i> button (bottom-left) to download your edited PDF.</li>
             </ol>
         </div>
     </div>

     <!-- Ad Block -->
    <div class="w-full max-w-4xl mx-auto my-8 text-center">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-9273434855071552"
             data-ad-slot="6257062799"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
    </div>

    <!-- Footer (Same as index.html) -->
    <footer class="bg-gray-700 text-gray-300 mt-12 py-8">
        <div class="container mx-auto px-6 text-center">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-sm">
                <div><h4 class="font-semibold mb-2 uppercase">SmileyPDF</h4><p>Free online tools to make your PDF tasks simple and secure.</p></div>
                <div><h4 class="font-semibold mb-2 uppercase">Quick Links</h4><ul><li><a href="index.html" class="hover:text-white">Home</a></li><li><a href="about.html" class="hover:text-white">About Us</a></li><li><a href="blog.html" class="hover:text-white">Blog</a></li><li><a href="contact.html" class="hover:text-white">Contact</a></li></ul></div>
                <div><h4 class="font-semibold mb-2 uppercase">Legal</h4><ul><li><a href="privacy.html" class="hover:text-white">Privacy Policy</a></li><li><a href="terms.html" class="hover:text-white">Terms of Service</a></li></ul></div>
            </div>
            <div class="border-t border-gray-600 pt-6 text-sm">&copy; <span id="current-year"></span> SmileyPDF. All rights reserved.</div>
        </div>
    </footer>

    <script>
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        const { jsPDF } = window.jspdf; // Make jsPDF available

        // --- Configuration ---
        const COLOR_MAP = { black: '#000000', red: '#EF4444', blue: '#3B82F6', green: '#10B981', orange: '#F59E0B', purple: '#8B5CF6', gray: '#6B7280', white: '#ffffff' };
        const HIGHLIGHT_COLOR_MAP = { yellow: 'rgba(253, 224, 71, ##OPACITY##)', green: 'rgba(75, 181, 67, ##OPACITY##)', blue: 'rgba(59, 130, 246, ##OPACITY##)', pink: 'rgba(236, 72, 153, ##OPACITY##)', purple: 'rgba(139, 92, 246, ##OPACITY##)' };
        const DEFAULT_TEXT_PROPS = { fontFamily: 'Arial, sans-serif', fontSize: 14, color: 'black', bold: false, italic: false, underline: false };
        const DEFAULT_HIGHLIGHT_PROPS = { color: 'yellow', opacity: 0.5 };
        const SIGNATURE_FONTS = {
            "Pacifico, cursive": "Pacifico", // Match display name to value used in CSS/JS
            "'Dancing Script', cursive": "Dancing Script",
            "'Brush Script MT', cursive": "Brush Script MT",
            "'Lucida Handwriting', cursive": "Lucida Handwriting",
            "Arial, sans-serif": "Arial"
        };

        // --- State Variables ---
        let pdfDoc = null, pdfFilename = 'No PDF Loaded', pageNum = 1, pageRendering = false, pageNumPending = null, scale = 1.0, totalPages = 0;
        let activeTool = null, annotations = [], selectedAnnotation = null, isDragging = false, isResizing = false, dragOffsetX = 0, dragOffsetY = 0, isDrawingHighlight = false, highlightStartX = 0, highlightStartY = 0, tempHighlightDiv = null;
        let signaturePad = null;
        let currentSignatureColor = 'black', currentTypedSignatureColor = 'black', currentSignatureFont = Object.keys(SIGNATURE_FONTS)[0]; // Default to first font
        let currentTextProperties = { ...DEFAULT_TEXT_PROPS };
        let currentHighlightProperties = { ...DEFAULT_HIGHLIGHT_PROPS };

        // --- DOM Elements ---
        const canvas = document.getElementById('pdf-canvas'), ctx = canvas.getContext('2d');
        const pdfContainer = document.getElementById('pdf-container');
        const pdfRender = document.getElementById('pdf-render');
        const pdfViewer = document.getElementById('pdf-viewer');
        const pageSelect = document.getElementById('page-select');
        const pageCountSpan = document.getElementById('page-count');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomLevelSpan = document.getElementById('zoom-level');
        const saveBtn = document.getElementById('save-pdf');
        const filenameTitle = document.getElementById('pdf-filename');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            populateFontOptions(); // Populate font selects dynamically
            initializeSignaturePad();
            window.addEventListener('resize', () => {
                 resizeSignatureCanvas();
                 if (pdfDoc) queueRenderPage(pageNum); // Re-render on resize
            });
            renderBlankCanvas(); // Show initial placeholder
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Load Google Fonts after DOM is ready
             WebFont.load({
                 google: {
                    families: ['Pacifico', 'Dancing Script'] // Load specific needed fonts
                }
            });
        });


        function populateFontOptions() {
             const textFontSelect = document.getElementById('text-font-family'); // Assuming you add an ID to text font container/select
             const sigFontSelect = document.getElementById('signature-font');

            // Populate Signature Font Select
             if(sigFontSelect) {
                 sigFontSelect.innerHTML = ''; // Clear existing
                 Object.entries(SIGNATURE_FONTS).forEach(([fontValue, fontName]) => {
                    const option = document.createElement('option');
                     option.value = fontValue;
                     option.textContent = fontName;
                     option.style.fontFamily = fontValue;
                     sigFontSelect.appendChild(option);
                 });
                sigFontSelect.value = currentSignatureFont; // Set initial value
            }

             // Populate Text Font Div (Example - adjust if using select)
             const textFontContainer = document.getElementById('text-tool-panel')?.querySelector('.font-options-container'); // Add a container div if using divs
            if (textFontContainer) {
                textFontContainer.innerHTML = '';
                 // Add similar logic to create font option divs/options as needed
                 // Example for the current div structure:
                 ['Arial, sans-serif', "'Times New Roman', Times, serif", "'Courier New', Courier, monospace", "Verdana, sans-serif", "Georgia, serif", "'Comic Sans MS', cursive, sans-serif"].forEach(font => {
                    const div = document.createElement('div');
                    div.className = 'font-option';
                    div.style.fontFamily = font;
                    div.dataset.font = font;
                     div.textContent = font.split(',')[0].replace(/['"]/g, ''); // Simple display name
                    if(font === DEFAULT_TEXT_PROPS.fontFamily) div.classList.add('selected');
                     div.onclick = function() { setCurrentTextProperty('fontFamily', this.dataset.font); };
                     textFontContainer.appendChild(div);
                 });
             }
        }


        function initializeSignaturePad() {
             const signatureCanvas = document.getElementById('signature-pad');
             if (!signatureCanvas) { console.warn("Signature pad canvas element not found."); return; }
             try {
                signaturePad = new SignaturePad(signatureCanvas, {
                     backgroundColor: 'rgba(255, 255, 255, 0)',
                     penColor: COLOR_MAP[currentSignatureColor] || COLOR_MAP.black
                 });
                 resizeSignatureCanvas();
             } catch(e) {
                 console.error("Error initializing SignaturePad:", e);
                 document.getElementById('draw-signature')?.classList.add('hidden'); // Hide draw option if error
                 switchSignatureMode(document.getElementById('type-signature'), 'type'); // Default to type mode
            }
         }

        function resizeSignatureCanvas() {
             if (!signaturePad || !signaturePad.canvas) return;
             const canvasEl = signaturePad.canvas;
             if (!canvasEl.offsetParent || canvasEl.offsetWidth === 0) return;
             const ratio = Math.max(window.devicePixelRatio || 1, 1);
             canvasEl.width = canvasEl.offsetWidth * ratio;
             canvasEl.height = canvasEl.offsetHeight * ratio;
             canvasEl.getContext('2d').scale(ratio, ratio);
             const data = signaturePad.toData(); // Save existing signature data
             signaturePad.clear(); // Need to clear before applying data
            if(data) signaturePad.fromData(data); // Redraw signature
         }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
             // Toolbar Buttons
             document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('file-input').click());
             document.getElementById('file-input').addEventListener('change', handleFileSelect);
             document.getElementById('text-tool').addEventListener('click', () => setActiveTool('text'));
             document.getElementById('signature-tool').addEventListener('click', () => setActiveTool('signature'));
             document.getElementById('image-tool').addEventListener('click', () => setActiveTool('image'));
             document.getElementById('highlight-tool').addEventListener('click', () => setActiveTool('highlight'));
             saveBtn.addEventListener('click', savePDF);

            // Top Bar Controls
             pageSelect.addEventListener('change', handlePageChange);
             zoomInBtn.addEventListener('click', () => updateZoom(0.25));
             zoomOutBtn.addEventListener('click', () => updateZoom(-0.25));

             // PDF Viewer Interaction (Main Listener)
             pdfContainer.addEventListener('mousedown', handleContainerMouseDown); // Attach to container to capture all clicks inside
             // Move and Up listeners on the window/document for better capture during drag
             window.addEventListener('mousemove', handleWindowMouseMove);
             window.addEventListener('mouseup', handleWindowMouseUp);

             // Tool Panel Specific Listeners
             setupTextPanelListeners();
             setupSignaturePanelListeners();
             setupImagePanelListeners();
             setupHighlightPanelListeners();

            // Global Deselection (Improved)
             document.addEventListener('click', (e) => {
                 // Only deselect if the click is truly outside relevant elements
                 const isOutsideAnnotation = !e.target.closest('.annotation');
                 const isOutsidePanel = !e.target.closest('.tool-panel');
                 const isOutsideToolbar = !e.target.closest('.w-16.bg-white'); // Check if click is not on toolbar
                 const isOutsideTopBar = !e.target.closest('.bg-white.shadow-sm'); // Check if not on top bar controls

                 if (selectedAnnotation && isOutsideAnnotation && isOutsidePanel && isOutsideToolbar && isOutsideTopBar) {
                    clearSelection();
                 }
             });

            // Keyboard Delete
             document.addEventListener('keydown', (e) => {
                // Check if focus is not in an input/textarea/contenteditable
                 const activeEl = document.activeElement;
                 const isInputFocused = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);

                if ((e.key === 'Delete' || e.key === 'Backspace') && selectedAnnotation && !isInputFocused) {
                     deleteAnnotation(selectedAnnotation.id);
                     e.preventDefault(); // Prevent browser back navigation on Backspace
                }
             });
         }

        // --- PDF Loading & Rendering --- (Largely unchanged, add Spinner calls)
        function showSpinner() { if(loadingSpinner) loadingSpinner.classList.remove('hidden'); }
        function hideSpinner() { if(loadingSpinner) loadingSpinner.classList.add('hidden'); }

        function handleFileSelect(event) {
             const file = event.target.files[0];
             if (file && file.type === 'application/pdf') {
                 pdfFilename = file.name; filenameTitle.textContent = pdfFilename; filenameTitle.title = pdfFilename; // Update title
                 showSpinner();
                 const reader = new FileReader();
                 reader.onload = (e) => loadPDF(new Uint8Array(e.target.result));
                 reader.onerror = () => { alert('Error reading file.'); hideSpinner(); resetToBlank();}
                 reader.readAsArrayBuffer(file);
             } else if (file) { alert('Please select a valid PDF file.'); }
             event.target.value = null; // Reset input
         }

         function loadPDF(data) {
            const loadingTask = pdfjsLib.getDocument({ data: data, cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.11.338/cmaps/', cMapPacked: true }); // Add cMaps for better text
            loadingTask.promise.then(pdf => {
                pdfDoc = pdf;
                totalPages = pdf.numPages;
                 updatePageSelect();
                 pageNum = 1; scale = 1.0; // Reset scale
                 zoomLevelSpan.textContent = '100%';
                 resetEditorState(); // Clear previous annotations etc.
                enableControls();
                 queueRenderPage(1); // Start rendering page 1
             }).catch(error => {
                console.error('Error loading PDF:', error);
                let errorMsg = 'Error loading PDF.';
                 if (error.name === 'PasswordException') {
                     errorMsg = 'PDF is password-protected. Please provide an unprotected file.';
                } else {
                     errorMsg = 'Could not load PDF. The file might be corrupted or invalid.';
                }
                 alert(errorMsg);
                 resetToBlank();
                 hideSpinner();
             });
         }

         function queueRenderPage(num) {
            if (pageRendering) { pageNumPending = num; } else { renderPage(num); }
         }

        function renderPage(num) {
             if (!pdfDoc || num < 1 || num > totalPages) { console.warn(`Invalid page number requested: ${num}`); return;}
             pageRendering = true; pageNum = num;
             showSpinner();
             pageSelect.value = num; // Ensure dropdown matches

            pdfDoc.getPage(num).then(page => {
                 const desiredWidth = pdfViewer.offsetWidth * 0.95; // Target 95% of viewer width initially
                let initialViewport = page.getViewport({ scale: 1.0 });
                 scale = desiredWidth / initialViewport.width; // Calculate scale to fit width
                scale = Math.min(scale, 2.0); // Limit max initial scale
                 scale = Math.max(0.25, scale); // Limit min initial scale
                 zoomLevelSpan.textContent = `${Math.round(scale * 100)}%`; // Update zoom display

                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height; canvas.width = viewport.width;
                pdfRender.style.width = viewport.width + 'px'; pdfRender.style.height = viewport.height + 'px';

                const renderContext = { canvasContext: ctx, viewport: viewport, /* enhanceTextSelection: true // For future text selection */ };
                 return page.render(renderContext).promise;
             }).then(() => {
                 pageRendering = false;
                 hideSpinner();
                 if (pageNumPending !== null) { const pending = pageNumPending; pageNumPending = null; renderPage(pending); }
                 else { redrawAnnotations(); } // Redraw only when current render finishes
             }).catch(err => {
                console.error("Error rendering page:", err);
                 pageRendering = false; hideSpinner();
             });
         }


        function renderBlankCanvas() {
             canvas.width = pdfViewer.offsetWidth * 0.8 || 600; // Default size based on viewer
            canvas.height = canvas.width * 1.414 || 840; // Approx A4 ratio
            pdfRender.style.width = canvas.width + 'px'; pdfRender.style.height = canvas.height + 'px';

             ctx.fillStyle = '#f9fafb'; // Light gray bg
             ctx.fillRect(0, 0, canvas.width, canvas.height);
             ctx.fillStyle = '#6b7280'; // Gray text
             ctx.font = '20px Arial'; ctx.textAlign = 'center';
             ctx.fillText('Upload or Drop a PDF to Start', canvas.width / 2, canvas.height / 2 - 20);
             ctx.font = '14px Arial';
             ctx.fillText('(Use the button or drag & drop file here)', canvas.width / 2, canvas.height / 2 + 10);
         }

        // Reset state *without* clearing the canvas immediately
        function resetEditorState() {
             annotations = [];
             clearSelection();
             setActiveTool(null);
             pdfContainer.querySelectorAll('.annotation').forEach(el => el.remove());
             if (signaturePad) signaturePad.clear();
             document.getElementById('signature-text').value = '';
             document.getElementById('initials-text').value = '';
             // Reset tool panel values if needed (optional)
             currentTextProperties = { ...DEFAULT_TEXT_PROPS };
             currentHighlightProperties = { ...DEFAULT_HIGHLIGHT_PROPS };
             updateTextPanelControls(currentTextProperties);
             updateHighlightPanelControls(currentHighlightProperties);
        }


        function resetToBlank() {
             pdfDoc = null; pdfFilename = 'No PDF Loaded'; filenameTitle.textContent = 'PDF Editor Tool'; filenameTitle.title = pdfFilename; pageNum = 1; scale = 1.0; totalPages = 0; zoomLevelSpan.textContent = '100%';
             updatePageSelect(); // Clears/disables select
             resetEditorState(); // Clear annotations data and UI elements
             renderBlankCanvas(); // Draw the placeholder text
             disableControls();
             hideSpinner();
        }


        function enableControls() {
            pageSelect.disabled = false;
            zoomInBtn.disabled = false;
            zoomOutBtn.disabled = false;
             saveBtn.disabled = false;
            document.querySelectorAll('.group > button[id$="-tool"]').forEach(btn => {btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed')}); // Enable tool buttons
        }
        function disableControls() {
             pageSelect.disabled = true;
             zoomInBtn.disabled = true;
             zoomOutBtn.disabled = true;
             saveBtn.disabled = true;
             document.querySelectorAll('.group > button[id$="-tool"]').forEach(btn => {btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed')});
        }


        function updatePageSelect() {
            pageSelect.innerHTML = ''; // Clear options
             if (totalPages > 0) {
                 for (let i = 1; i <= totalPages; i++) {
                     const option = document.createElement('option'); option.value = i; option.textContent = '' + i; pageSelect.appendChild(option);
                 }
                 pageCountSpan.textContent = `of ${totalPages}`;
                 pageSelect.disabled = totalPages <= 1; // Disable if only 1 page
                 pageSelect.value = pageNum;
            } else {
                pageSelect.innerHTML = '<option>N/A</option>';
                pageCountSpan.textContent = '';
                 pageSelect.disabled = true;
            }
        }

        // --- Viewer Interaction Handlers (using listeners on window/container now) ---

        function handleContainerMouseDown(e) {
            const target = e.target;
             // Check if the click started on an annotation
             const clickedAnnotation = target.closest('.annotation');
             if (clickedAnnotation) {
                // Prevent drag/resize if clicking delete button or editable content
                if (target.classList.contains('delete-btn') || target.isContentEditable) {
                     // If contenteditable, select the annotation and activate text tool
                    if(target.isContentEditable) {
                         selectAnnotation(clickedAnnotation);
                         setActiveTool('text');
                         // Let browser handle focus etc.
                     }
                    return;
                }

                // Check if click is on resize handle (simple check)
                 const isResizeHandle = e.offsetX >= clickedAnnotation.offsetWidth - 10 && e.offsetY >= clickedAnnotation.offsetHeight - 10;

                selectAnnotation(clickedAnnotation); // Select it

                 if (isResizeHandle && clickedAnnotation.style.resize !== 'none') { // Check if resizable
                    isResizing = true;
                    isDragging = false;
                     dragOffsetX = e.clientX; // Store initial mouse pos for resize calc
                     dragOffsetY = e.clientY;
                    pdfViewer.style.cursor = 'nwse-resize';
                } else { // Start dragging
                    isDragging = true;
                     isResizing = false;
                    // Offset from top-left corner of the dragged element
                     const rect = clickedAnnotation.getBoundingClientRect();
                     dragOffsetX = e.clientX - rect.left;
                     dragOffsetY = e.clientY - rect.top;
                     pdfViewer.style.cursor = 'move';
                 }
                 e.preventDefault(); // Prevent browser drag behavior, text selection etc.

            } else if ((target === canvas || target === pdfContainer || target === pdfRender) && activeTool === 'highlight' && pdfDoc) {
                // Start drawing highlight rectangle
                isDrawingHighlight = true;
                 const rect = canvas.getBoundingClientRect(); // Get canvas pos relative to viewport
                 // Calculate mouse pos relative to canvas, accounting for scroll
                 highlightStartX = e.clientX - rect.left + pdfViewer.scrollLeft;
                 highlightStartY = e.clientY - rect.top + pdfViewer.scrollTop;

                tempHighlightDiv = document.createElement('div');
                 tempHighlightDiv.style.position = 'absolute'; // Position relative to pdfContainer
                 tempHighlightDiv.style.border = '1px dashed #4F46E5';
                 tempHighlightDiv.style.backgroundColor = HIGHLIGHT_COLOR_MAP[currentHighlightProperties.color]?.replace('##OPACITY##', currentHighlightProperties.opacity) || 'rgba(255, 255, 0, 0.3)';
                 tempHighlightDiv.style.left = highlightStartX + 'px';
                 tempHighlightDiv.style.top = highlightStartY + 'px';
                 tempHighlightDiv.style.width = '0px';
                 tempHighlightDiv.style.height = '0px';
                 tempHighlightDiv.style.zIndex = '6'; // Above canvas
                 tempHighlightDiv.style.pointerEvents = 'none';
                 pdfContainer.appendChild(tempHighlightDiv); // Append to container

                 pdfViewer.style.cursor = 'crosshair';
                 e.preventDefault();
            } else {
                 // Mousedown on empty space, potentially deselect? Handled by global click listener now.
            }
        }


        function handleWindowMouseMove(e) {
             if (isDragging && selectedAnnotation) {
                 // Calculate new top/left based on initial offset and current mouse position relative to viewer
                 const viewerRect = pdfViewer.getBoundingClientRect();
                 // Mouse pos relative to viewer viewport
                let mouseX = e.clientX - viewerRect.left;
                 let mouseY = e.clientY - viewerRect.top;
                 // Account for scroll position to get pos relative to the full scrollable content
                 mouseX += pdfViewer.scrollLeft;
                 mouseY += pdfViewer.scrollTop;

                let newX = mouseX - dragOffsetX;
                 let newY = mouseY - dragOffsetY;

                // Constrain within canvas bounds
                 newX = Math.max(0, Math.min(newX, canvas.offsetWidth - selectedAnnotation.offsetWidth));
                 newY = Math.max(0, Math.min(newY, canvas.offsetHeight - selectedAnnotation.offsetHeight));

                 selectedAnnotation.style.left = newX + 'px';
                 selectedAnnotation.style.top = newY + 'px';

             } else if (isResizing && selectedAnnotation) {
                 // Calculate new width/height based on initial pos and current mouse pos
                 const initialWidth = selectedAnnotation.offsetWidth;
                 const initialHeight = selectedAnnotation.offsetHeight;
                 const dx = e.clientX - dragOffsetX; // Change in mouse X since drag start
                 const dy = e.clientY - dragOffsetY; // Change in mouse Y

                let newWidth = initialWidth + dx;
                 let newHeight = initialHeight + dy;

                 // Minimum size constraints
                 newWidth = Math.max(20, newWidth);
                 newHeight = Math.max(20, newHeight);

                // Max size constraints (within canvas bounds from its origin)
                 newWidth = Math.min(newWidth, canvas.offsetWidth - selectedAnnotation.offsetLeft);
                 newHeight = Math.min(newHeight, canvas.offsetHeight - selectedAnnotation.offsetTop);

                 selectedAnnotation.style.width = newWidth + 'px';
                 selectedAnnotation.style.height = (selectedAnnotation.dataset.type === 'text' ? 'auto' : newHeight + 'px'); // Allow text height auto-adjust


                 // Update dragOffsetX/Y for continuous resize calculation relative to last pos
                 // dragOffsetX = e.clientX; // Actually, no, keep initial click pos for size calculation from start point
                 // dragOffsetY = e.clientY;


            } else if (isDrawingHighlight && tempHighlightDiv) {
                const rect = canvas.getBoundingClientRect();
                 // Calculate current mouse position relative to canvas, including scroll
                 const currentX = e.clientX - rect.left + pdfViewer.scrollLeft;
                 const currentY = e.clientY - rect.top + pdfViewer.scrollTop;

                const left = Math.min(currentX, highlightStartX);
                 const top = Math.min(currentY, highlightStartY);
                 const width = Math.abs(currentX - highlightStartX);
                 const height = Math.abs(currentY - highlightStartY);

                tempHighlightDiv.style.left = `${left}px`;
                tempHighlightDiv.style.top = `${top}px`;
                tempHighlightDiv.style.width = `${width}px`;
                tempHighlightDiv.style.height = `${height}px`;
            }
        }


        function handleWindowMouseUp(e) {
            if (isDragging || isResizing) {
                if(selectedAnnotation) {
                    // Final update to the data object
                    updateAnnotationData(selectedAnnotation);
                }
             }
             if (isDrawingHighlight && tempHighlightDiv) {
                // Get final dimensions from the temporary div
                 const width = parseFloat(tempHighlightDiv.style.width);
                 const height = parseFloat(tempHighlightDiv.style.height);
                 const left = parseFloat(tempHighlightDiv.style.left);
                 const top = parseFloat(tempHighlightDiv.style.top);

                 tempHighlightDiv.remove(); // Remove visual feedback div
                 tempHighlightDiv = null;

                // Add the actual annotation if size is meaningful
                 if (width > 5 && height > 5) {
                    addAnnotation(left, top, width, height, 'highlight');
                 }
             }

             // Reset interaction states
             if (isDragging || isResizing || isDrawingHighlight) {
                 isDragging = false;
                 isResizing = false;
                 isDrawingHighlight = false;
                 pdfViewer.style.cursor = 'default'; // Reset cursor
            }

            // Check if it was a click to add text
            if (activeTool === 'text' && !e.target.closest('.annotation') && !e.target.closest('.tool-panel') && (e.target === canvas || e.target === pdfContainer || e.target === pdfRender) && !isDragging && !isResizing && !isDrawingHighlight) {
                 // Verify it wasn't part of a drag (mouseup after slight unintentional move)
                 // This logic might be tricky, maybe handle text add on mousedown/click instead if simpler

                // Let's try adding on mouseup if it wasn't a drag action:
                 if (Math.abs(e.clientX - (dragOffsetX)) < 5 && Math.abs(e.clientY - (dragOffsetY)) < 5 ) { // Basic check if mouse moved much
                     const rect = canvas.getBoundingClientRect();
                     const x = e.clientX - rect.left + pdfViewer.scrollLeft;
                     const y = e.clientY - rect.top + pdfViewer.scrollTop;
                     addAnnotation(x, y, 200, 'auto', 'text'); // Add text annotation
                     dragOffsetX = 0; dragOffsetY = 0; // Reset potential minor drag values
                 }
             }
             dragOffsetX = 0; dragOffsetY = 0; // Reset offsets after mouseup


         }

        // (Removed handleViewerClick - replaced by logic within mousedown/mouseup/global click listener)


        // --- Tool State Management & Panel Updates --- (Largely unchanged)
         function setActiveTool(tool) {
             if (activeTool === tool && tool !== null) { tool = null; } // Deselect if clicked again
            // ... (rest of setActiveTool logic remains the same) ...
             if (activeTool) {
                 const toolBtn = document.getElementById(`${activeTool}-tool`);
                 if (toolBtn) toolBtn.classList.add('active-tool');
                 const panelId = `${activeTool}-tool-panel`;
                 const panel = document.getElementById(panelId);
                 if (panel) {
                     panel.style.display = 'block';
                     // Ensure panel updates if needed when activated
                    switch (activeTool) {
                        case 'text': updateTextPanelControls(currentTextProperties); break;
                         case 'signature': resizeSignatureCanvas(); break; // Ensure canvas sized when shown
                        case 'highlight': updateHighlightPanelControls(currentHighlightProperties); break;
                    }
                 }
             } else {
                // Optionally clear selection when no tool is active?
                // clearSelection();
            }
            pdfViewer.style.cursor = (tool === 'text') ? 'text' : (tool === 'highlight') ? 'crosshair' : 'default';
        }
        // --- Annotation Creation/Manipulation/Deletion --- (Minor adjustments, ensure correct parameters)
         function addAnnotation(x, y, width = 0, height = 0, type) {
            if (!type || !pdfDoc) return;
            // ... (rest of addAnnotation logic, using width/height params correctly for highlight) ...
            if(type === 'text') annotationDiv.style.width = `${width || 200}px`;
            if(type === 'highlight') {
                 annotationDiv.style.width = `${width}px`;
                 annotationDiv.style.height = `${height}px`;
                 // ... rest of highlight setup
                 annotationData.width = width;
                 annotationData.height = height;
            }
             // ... add to DOM, annotations array, select it ...
             pdfContainer.appendChild(annotationDiv); annotations.push(annotationData); if (type === 'text') annotationData.height = annotationDiv.offsetHeight; selectAnnotation(annotationDiv);
         }

        // --- PDF Saving --- (Refined font embedding and structure)
        async function savePDF() {
            if (!pdfDoc) { alert('No PDF loaded.'); return; }
            const annotationsToSave = JSON.parse(JSON.stringify(annotations)); // Deep copy
            showSpinner(); saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; console.log('Save started...');

            try {
                // --- Font Preloading (if using non-standard fonts heavily) ---
                 // This is complex with jsPDF. Standard fonts usually okay. Custom might need font file loading.
                 // For now, rely on jsPDF standard fonts or system fonts if available during generation.

                 // Get page dimensions accurately first
                 const pageDimensions = [];
                 for (let i = 1; i <= totalPages; i++) {
                     const page = await pdfDoc.getPage(i);
                     const viewport = page.getViewport({ scale: 1.0 });
                     pageDimensions.push({ width: viewport.width, height: viewport.height });
                 }

                // Create jsPDF instance - potentially with first page size
                const firstPageDim = pageDimensions[0] || { width: 595.28, height: 841.89 }; // Default A4 pt
                const newPdf = new jsPDF({
                    unit: 'pt',
                    format: [firstPageDim.width, firstPageDim.height],
                    compress: true // Enable compression
                 });

                 // Standard fonts built into jsPDF
                 const standardFonts = newPdf.getFontList();
                 console.log("Available standard fonts in jsPDF:", standardFonts);


                 const loadImage = (src) => new Promise((resolve, reject) => { const img = new Image(); img.onload = () => resolve(img); img.onerror = (err) => { console.error("Image load failed in save:", src.substring(0,50), err); reject(err);}; img.src = src; });
                 const tempCanvas = document.createElement('canvas');
                 const tempCtx = tempCanvas.getContext('2d');

                for (let i = 1; i <= totalPages; i++) {
                    console.log(`Processing page ${i}...`);
                     const page = await pdfDoc.getPage(i);
                     const dims = pageDimensions[i-1];
                    const viewport = page.getViewport({ scale: 1.0 }); // Use 1x scale for drawing quality

                    // Add page with correct dimensions *before* drawing
                     if (i > 1) {
                        newPdf.addPage([dims.width, dims.height], dims.width > dims.height ? 'landscape' : 'portrait');
                    }
                     newPdf.setPage(i); // Ensure we're drawing on the correct page

                    tempCanvas.width = viewport.width; tempCanvas.height = viewport.height;

                    // 1. Render original page to temp canvas
                     await page.render({ canvasContext: tempCtx, viewport: viewport }).promise;

                    // 2. Draw annotations onto the temp canvas
                    const pageAnnotations = annotationsToSave.filter(a => a.page === i);
                    for (const annotation of pageAnnotations) {
                        const pdfX = annotation.x / scale; // Convert back from current display scale
                        const pdfY = annotation.y / scale;
                         const pdfWidth = annotation.width / scale;
                         let pdfHeight = annotation.height === 'auto' ? (DEFAULT_TEXT_PROPS.fontSize*1.2 / scale) : (annotation.height / scale); // Recalc below

                        tempCtx.save();
                        try {
                             switch (annotation.type) {
                                case 'text':
                                    const props = annotation.properties || DEFAULT_TEXT_PROPS;
                                    const fontSize = (props.fontSize || 14) / scale;
                                    let fontName = props.fontFamily?.split(',')[0].replace(/['"]/g,'').trim() || 'Helvetica'; // Default to Helvetica/Arial

                                    // Basic jsPDF font mapping (improve as needed)
                                    if (!standardFonts[fontName.toLowerCase()]) {
                                         console.warn(`Font ${fontName} not standard. Falling back to Helvetica.`); fontName = 'Helvetica'; // Fallback
                                     }

                                    let jsPdfFontStyle = '';
                                     if(props.bold && props.italic) jsPdfFontStyle = 'bolditalic';
                                     else if(props.bold) jsPdfFontStyle = 'bold';
                                     else if(props.italic) jsPdfFontStyle = 'italic';
                                     else jsPdfFontStyle = 'normal';

                                     // jsPDF doesn't directly support text underline draw on canvas. Needs manual line drawing.
                                     // Use canvas font setting for accurate text drawing before adding to jsPDF
                                     tempCtx.font = `${props.italic ? 'italic ' : ''}${props.bold ? 'bold ' : ''}${fontSize}px ${props.fontFamily || 'Arial'}`;
                                     tempCtx.fillStyle = COLOR_MAP[props.color || 'black'] || COLOR_MAP.black;
                                     tempCtx.textBaseline = 'top';

                                     const lines = (annotation.content || '').split('\n');
                                     const lineHeight = fontSize * 1.2;
                                     pdfHeight = lines.length * lineHeight; // Calculated height

                                    for(let lineIdx = 0; lineIdx < lines.length; lineIdx++) {
                                         const lineY = pdfY + (lineIdx * lineHeight);
                                         tempCtx.fillText(lines[lineIdx], pdfX, lineY);
                                        if (props.underline) { /* Manual underline logic here on canvas if needed */ }
                                     }
                                     break;

                                case 'highlight': /* Draw highlight rect directly */ break; // Let canvas draw handle this
                                case 'signature': /* Draw signature img/text directly */ break; // Canvas handles
                                 case 'image': /* Draw image directly */ break; // Canvas handles
                             }
                        } catch (drawErr) { console.error("Annotation draw err:", drawErr); }
                        finally { tempCtx.restore(); }
                    } // End loop through annotations for page

                     // 3. Add the combined image to jsPDF
                     // Important: Get image AFTER drawing annotations on temp canvas
                    const imgData = tempCanvas.toDataURL('image/png', 0.95); // Slightly higher quality PNG
                    newPdf.addImage(imgData, 'PNG', 0, 0, dims.width, dims.height, undefined, 'FAST'); // Add using correct page dims
                    console.log(` Page ${i} rendered and added.`);
                 } // End loop through pages

                 console.log('Generating final PDF...');
                 const newFilename = pdfFilename.replace(/\.pdf$/i, '-edited.pdf');
                 newPdf.save(newFilename); // Trigger download

            } catch (error) {
                 console.error('Error during PDF save process:', error);
                 alert('An error occurred while saving the PDF. Please check the console.');
            } finally {
                 hideSpinner(); saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save text-lg"></i>'; console.log('Save finished.');
            }
        }


        // --- Global Helper Functions --- (Keep as is)

    </script>

</body>
</html>