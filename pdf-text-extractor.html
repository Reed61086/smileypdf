<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Text Extractor</title>
    <link rel="icon" type="image/png" href="logo.png">
    <!-- Base CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Additional Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .file-upload-container {
            border: 2px dashed #93C5FD;
            transition: all 0.3s ease;
        }
        .file-upload-container:hover {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }
        .file-upload-container.drag-over {
            border-color: #2563EB;
            background-color: #DBEAFE;
        }
        .option-card {
            transition: all 0.3s ease;
        }
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .option-card.selected {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }
        #progressBar {
            transition: width 0.5s ease, background-color 0.5s ease; /* Added background-color transition */
        }
        /* Custom Tesseract progress styling */
        .progress-bar-ocr {
            background-color: #6d28d9; /* Purple for OCR */
        }
        .progress-bar-text {
             background-color: #16a34a; /* Green for text */
         }
         .progress-bar-formatting {
              background-color: #ea580c; /* Orange for formatting */
         }
         /* Tesseract logging visibility */
        #tesseract-log-container {
            max-height: 100px;
            overflow-y: auto;
            background-color: #e5e7eb; /* Light gray background */
            border: 1px solid #d1d5db;
            padding: 8px;
            font-family: monospace;
            font-size: 0.75rem; /* Small text */
            line-height: 1.2;
            color: #374151; /* Darker gray text */
            border-radius: 4px;
            margin-top: 8px;
        }
         #tesseract-log-container p {
             margin-bottom: 2px;
             word-break: break-all;
         }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
 <!-- Header -->
 <header x-data="{ mobileMenuOpen: false }" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 py-1 flex justify-between items-center">
        <a href="index.html" class="flex items-center transition duration-150 ease-in-out hover:opacity-80">
           <img src="logo.png" alt="SmileyPDF Logo" class="h-20 w-auto mr-2">
        </a>
        <div class="hidden md:flex items-center space-x-4">
            <a href="index.html" class="hover:text-blue-200 font-medium px-3 py-2 rounded-md text-sm">Home</a>
             <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @keydown.escape.window="open = false" class="hover:text-blue-200 font-medium focus:outline-none flex items-center px-3 py-2 rounded-md text-sm">
                    Tools <i class="fas fa-chevron-down ml-1 text-xs"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20 text-gray-700 py-1 origin-top-right" style="display: none;">
                     <a href="pdf-editor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF Editor</a>
                     <a href="merge-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Merge PDF</a>
                     <a href="image-to-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Image to PDF</a>
                     <a href="pdf-rotator.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Rotate PDF</a>
                     <a href="pdf-text-extractor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Extract PDF Text</a>
                     <a href="pdf-to-jpg.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to JPG</a>
                     <a href="pdf-to-word.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Word</a>
                 </div>
             </div>
         </div>
          <div class="md:hidden">
              <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white focus:outline-none p-2 rounded hover:bg-blue-600">
                  <span class="sr-only">Open menu</span>
                  <i x-show="!mobileMenuOpen" class="fa-solid fa-bars text-xl"></i>
                  <i x-show="mobileMenuOpen" class="fa-solid fa-times text-xl" style="display: none;"></i>
              </button>
         </div>
    </nav>
     <div x-show="mobileMenuOpen" @click.away="mobileMenuOpen = false" x-transition class="md:hidden absolute inset-x-0 top-full bg-blue-600 shadow-lg border-t border-blue-500" style="display: none;">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Home</a>
            <h3 class="px-3 pt-4 pb-1 text-xs font-semibold text-blue-200 uppercase tracking-wider">Tools</h3>
            <a href="pdf-editor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF Editor</a>
            <a href="merge-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Merge PDF</a>
            <a href="image-to-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Image to PDF</a>
            <a href="pdf-rotator.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Rotate PDF</a>
            <a href="pdf-text-extractor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Extract PDF Text</a>
            <a href="pdf-to-jpg.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to JPG</a>
            <a href="pdf-to-word.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Word</a>
        </div>
     </div>
</header>
    <div class="container mx-auto px-4 py-12">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800 mb-3">PDF Text Extractor</h1>
                <p class="text-gray-600">Upload your PDF document and extract text with various options</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="file-upload-container rounded-lg p-8 text-center cursor-pointer" id="dropZone">
                    <i class="fas fa-file-pdf text-6xl text-blue-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Upload PDF Document</h3>
                    <p class="text-gray-500 mb-4">Drag & drop your PDF file here or click to browse</p>
                    <input type="file" id="pdfInput" accept=".pdf" class="hidden">
                    <button id="uploadBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                        <i class="fas fa-upload mr-2"></i> Select PDF File
                    </button>
                    <p id="fileName" class="mt-3 text-sm text-gray-500 hidden"></p>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Choose Extraction Options</h3>
                <div class="grid md:grid-cols-3 gap-4"> <!-- Changed to 3 columns -->
                    <div class="option-card p-5 border rounded-lg cursor-pointer bg-white shadow-sm" data-option="text">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-4 shrink-0"> <i class="fas fa-file-alt text-green-600"></i> </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">Extract Text (Fastest)</h4>
                                <p class="text-gray-600 text-sm">Best for PDFs already containing selectable text (not scans).</p>
                            </div>
                        </div>
                    </div>
                    <div class="option-card p-5 border rounded-lg cursor-pointer bg-white shadow-sm selected" data-option="ocr"> <!-- Set OCR as default selected -->
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-4 shrink-0"> <i class="fas fa-eye text-purple-600"></i> </div>
                            <div>
                                <h4 class="font-medium text-gray-800 mb-1">OCR for Scanned PDFs (Image-based)</h4>
                                <p class="text-gray-600 text-sm">Uses OCR to extract text from scanned documents. Can be slower.</p>
                            </div>
                        </div>
                    </div>
                     <div class="option-card p-5 border rounded-lg cursor-pointer bg-white shadow-sm" data-option="formatting">
                         <div class="flex items-start">
                             <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-4 shrink-0"> <i class="fas fa-align-left text-blue-600"></i> </div>
                             <div>
                                 <h4 class="font-medium text-gray-800 mb-1">Basic Formatting (TXT)</h4>
                                 <p class="text-gray-600 text-sm">Extracts text and attempts simple formatting. Saves as .txt.</p>
                             </div>
                         </div>
                     </div>
                </div>
            </div>

            <div id="processingSection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Processing PDF</h3>
                    <div id="progressText" class="text-sm text-gray-500">0%</div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div id="statusMessage" class="mt-2 text-sm text-gray-500"></div>
                 <div id="tesseract-log-container" class="hidden"> <!-- Container for Tesseract logs -->
                     <p class="font-semibold text-xs mb-1">OCR Progress Details:</p>
                     <div id="tesseract-log"></div>
                 </div>
            </div>

            <div id="resultSection" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Extracted Contents</h3>
                    <div>
                        <button id="copyBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1.5 px-4 rounded-lg text-sm transition duration-300 mr-2">
                            <i class="fas fa-copy mr-2"></i> Copy
                        </button>
                        <button id="downloadBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-4 rounded-lg text-sm transition duration-300">
                            <i class="fas fa-download mr-2"></i> Download (.txt)
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="extractedText" class="text-gray-800 whitespace-pre-line max-h-96 overflow-y-auto border border-gray-200 p-4 rounded bg-gray-50"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const pdfInput = document.getElementById('pdfInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropZone = document.getElementById('dropZone');
            const fileName = document.getElementById('fileName');
            const optionCards = document.querySelectorAll('.option-card');
            const processingSection = document.getElementById('processingSection');
            const resultSection = document.getElementById('resultSection');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusMessage = document.getElementById('statusMessage');
            const extractedText = document.getElementById('extractedText');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyBtn = document.getElementById('copyBtn');
            const tesseractLogContainer = document.getElementById('tesseract-log-container');
            const tesseractLog = document.getElementById('tesseract-log');


            let selectedOption = 'ocr'; // Default option now OCR
            let currentFile = null;
            let extractedContentCache = '';
            let tesseractWorker = null; // Hold the Tesseract worker

             // Check for library presence
            if (typeof window.pdfjsLib === 'undefined') { alert('Error: pdf.js library not loaded.'); console.error('pdf.js not loaded.'); return; }
            if (typeof window.saveAs === 'undefined') { console.warn('FileSaver.js not loaded.'); }
            if (typeof window.Tesseract === 'undefined') { alert('Error: Tesseract.js library not loaded. OCR will not work.'); console.error('Tesseract.js not loaded.'); return;}

            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

            // --- UI Event Listeners ---
             optionCards.forEach(card => {
                card.addEventListener('click', function() {
                    optionCards.forEach(c => c.classList.remove('selected', 'border-blue-500')); // Clear previous selection styles
                    this.classList.add('selected', 'border-blue-500');
                    selectedOption = this.getAttribute('data-option');
                    // Change progress bar color based on selection
                     progressBar.classList.remove('progress-bar-ocr', 'progress-bar-text', 'progress-bar-formatting', 'bg-blue-600');
                    if (selectedOption === 'ocr') progressBar.classList.add('progress-bar-ocr');
                     else if (selectedOption === 'text') progressBar.classList.add('progress-bar-text');
                    else if (selectedOption === 'formatting') progressBar.classList.add('progress-bar-formatting');
                    else progressBar.classList.add('bg-blue-600'); // Default blue
                 });
             });
             document.querySelector('.option-card[data-option="ocr"]').click(); // Set default visually


            uploadBtn.addEventListener('click', () => pdfInput.click());
            dropZone.addEventListener('click', (e) => { if(e.target === dropZone || dropZone.contains(e.target) && !e.target.closest('button, input')) pdfInput.click(); });
            pdfInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileUpload(e.target.files[0]); });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); if (e.dataTransfer.files.length > 0 && e.dataTransfer.files[0].type === 'application/pdf') handleFileUpload(e.dataTransfer.files[0]); else alert('Please upload a valid PDF file'); });
            copyBtn.addEventListener('click', copyResultToClipboard);
            // Download setup is dynamic within processPDF

            // --- Core Logic ---
            function handleFileUpload(file) {
                resetState();
                currentFile = file;
                if (!currentFile || (!currentFile.type.includes('pdf') && !currentFile.name.toLowerCase().endsWith('.pdf'))) { alert('Please select a PDF file.'); resetState(); return; }

                fileName.textContent = `File: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
                fileName.classList.remove('hidden');
                processingSection.classList.remove('hidden');
                updateProgress(0, 'Initializing...');
                extractedText.textContent = '';
                tesseractLogContainer.classList.add('hidden'); // Hide Tesseract log
                tesseractLog.innerHTML = '';

                setTimeout(() => { processPDF(file); }, 100);
            }

            function updateProgress(percentage, statusMsg = null) {
                const clamped = Math.min(100, Math.max(0, Math.round(percentage)));
                progressBar.style.width = `${clamped}%`;
                progressText.textContent = `${clamped}%`;
                if (statusMsg) statusMessage.textContent = statusMsg;
            }

             function updateOcrProgress(logData) {
                console.log(logData); // Log full Tesseract progress object for debugging
                 // Display current status
                if (logData.status) {
                    statusMessage.textContent = `OCR: ${logData.status}...`;
                     // Append detailed logs if needed
                    const p = document.createElement('p');
                     p.textContent = `[${new Date().toLocaleTimeString()}] ${logData.status}` + (logData.progress ? ` (${(logData.progress * 100).toFixed(1)}%)` : '');
                    tesseractLog.appendChild(p);
                    tesseractLogContainer.scrollTop = tesseractLogContainer.scrollHeight; // Scroll to bottom
                 }
                // Update overall progress bar - based roughly on status phases
                 let overallProgress = 0;
                 switch(logData.status) {
                     case 'loading': overallProgress = 5; break;
                    case 'recognizing text': overallProgress = 15 + (logData.progress || 0) * 80; break; // Map 0-1 to 15-95%
                     case 'terminated': overallProgress = 98; break; // Near completion
                     default: // initializing, loading language etc. keep progress low
                        overallProgress = Math.max(parseFloat(progressBar.style.width) || 0, 10); // Maintain or slight bump
                        break;
                }
                updateProgress(overallProgress); // Update the main progress bar
            }


             async function processPDF(file) {
                 extractedContentCache = ''; // Clear cache
                 let finalFilename = currentFile.name.replace(/\.pdf$/i, ''); // Prepare filename without extension
                 const arrayBuffer = await file.arrayBuffer();
                extractedText.classList.remove('ocr-watermark'); // Reset style

                try {
                    if (selectedOption === 'ocr') {
                         statusMessage.textContent = 'Initializing OCR engine...';
                        tesseractLogContainer.classList.remove('hidden');
                         updateProgress(5);
                         extractedContentCache = await extractTextWithTesseract(arrayBuffer);
                         finalFilename += '_ocr.txt';
                         updateProgress(100, 'OCR Complete.');
                         extractedText.classList.add('ocr-watermark');
                     } else if (selectedOption === 'formatting') {
                         statusMessage.textContent = 'Extracting text content...';
                         updateProgress(20);
                         const rawText = await extractTextFromPDFjs(arrayBuffer);
                         extractedContentCache = simulateWordFormatting(rawText);
                         finalFilename += '_formatted.txt';
                         statusMessage.textContent = 'Simulating formatting...';
                         updateProgress(100);
                     } else { // 'text'
                         statusMessage.textContent = 'Extracting text content...';
                         updateProgress(20);
                         extractedContentCache = await extractTextFromPDFjs(arrayBuffer);
                         finalFilename += '_extracted.txt';
                         updateProgress(100);
                    }

                     extractedText.textContent = extractedContentCache || (selectedOption === 'ocr' ? "No text recognized via OCR." : "No text could be extracted.");

                    // Final UI update after processing
                     processingSection.classList.add('hidden');
                     resultSection.classList.remove('hidden');

                    downloadBtn.onclick = () => { downloadResult(extractedContentCache, finalFilename); };

                 } catch (error) {
                     console.error('Error processing PDF:', error);
                     statusMessage.textContent = 'Error processing PDF: ' + error.message;
                     extractedText.textContent = "Error processing PDF. Please try again.";
                     processingSection.classList.add('hidden');
                     resultSection.classList.remove('hidden');
                     updateProgress(0); // Reset progress on error
                 }
             }

            async function renderPdfPageToCanvas(pdfPage, scale = 1.5) { // Render at ~150 DPI for better OCR
                const viewport = pdfPage.getViewport({ scale: scale });
                 const offscreenCanvas = document.createElement('canvas');
                 const offscreenCtx = offscreenCanvas.getContext('2d');
                offscreenCanvas.width = viewport.width;
                offscreenCanvas.height = viewport.height;

                await pdfPage.render({ canvasContext: offscreenCtx, viewport: viewport }).promise;
                 return offscreenCanvas;
             }

              async function extractTextWithTesseract(typedArray) {
                  let fullText = '';
                  const { createWorker } = Tesseract;
                 tesseractWorker = await createWorker('eng', 1, { // Use English, Tesseract v5+ LSTM only
                    logger: m => updateOcrProgress(m), // Detailed progress
                     //cacheMethod: 'none' // May help if memory is an issue, but slows re-runs
                  });

                   const pdf = await pdfjsLib.getDocument(typedArray).promise;
                   const totalPages = pdf.numPages;

                   updateProgress(10, 'Preparing pages for OCR...'); // Update status

                   for (let i = 1; i <= totalPages; i++) {
                       statusMessage.textContent = `Processing page ${i}/${totalPages} with OCR...`;
                      const page = await pdf.getPage(i);
                       const canvas = await renderPdfPageToCanvas(page, 2.0); // Use higher scale for OCR

                       try {
                           const { data: { text } } = await tesseractWorker.recognize(canvas);
                            fullText += `--- Page ${i} ---\n${text}\n\n`;
                       } catch(recognizeError) {
                            console.error(`Error recognizing page ${i}:`, recognizeError);
                           fullText += `--- Page ${i} (OCR Error: ${recognizeError.message}) ---\n\n`;
                       }

                       const progress = 10 + (i / totalPages) * 85; // Allocate 85% of progress to OCR pages
                       updateProgress(progress);
                       await new Promise(resolve => setTimeout(resolve, 5)); // Small UI yield
                    }

                   await tesseractWorker.terminate();
                   tesseractWorker = null; // Clean up
                   updateProgress(98, 'Finalizing...');
                   return fullText;
              }


            async function extractTextFromPDFjs(typedarray) {
                 const loadingTask = pdfjsLib.getDocument(typedarray);
                 const pdf = await loadingTask.promise;
                 let fullText = '';
                 const totalPages = pdf.numPages;
                updateProgress(30);

                 for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                     const page = await pdf.getPage(pageNum);
                     const textContent = await page.getTextContent();
                     const pageText = textContent.items.map(item => item.str).join(' ');
                     fullText += `--- Page ${pageNum} ---\n${pageText}\n\n`;
                     const progress = 30 + (pageNum / totalPages) * 65;
                     updateProgress(progress, `Extracting text from page ${pageNum}/${totalPages}...`);
                    if(pageNum % 10 === 0) await new Promise(resolve => setTimeout(resolve, 5));
                }
                 return fullText;
            }

            function simulateWordFormatting(text) {
                let formatted = '';
                const lines = text.split('\n');
                 let inHeader = false; // Simple state to track potential headers
                lines.forEach(line => {
                    const trimmed = line.trim();
                    if(trimmed.length === 0) {
                        if (!formatted.endsWith('\n\n') && formatted.length > 0) formatted += '\n'; // Preserve single blank lines
                        inHeader = false;
                         return;
                     }
                    // Attempt to detect potential headers (e.g., shorter, all caps, maybe specific keywords?)
                    if (/^[A-Z\s.,'-:]{5,70}$/.test(trimmed) && trimmed.length < 70 && !inHeader && formatted.endsWith('\n\n')) {
                         formatted += '## ' + trimmed + '\n\n'; // Use markdown-like indication
                        inHeader = true;
                    }
                     // Detect simple list items
                    else if (/^\s*([-*•o]|\d+\.)\s+/.test(line)) {
                         formatted += '- ' + trimmed.substring(trimmed.search(/\s/)+1) + '\n';
                        inHeader = false;
                     } else {
                        formatted += trimmed + ' ';
                        if(/[.?!]$/.test(trimmed)) formatted += '\n'; // Add line break after sentences
                         inHeader = false;
                     }
                 });
                 return formatted.replace(/\s\n/g, '\n').replace(/\n\n+/g, '\n\n').trim(); // Cleanup
            }


            function downloadResult(content, filename) {
                try {
                     const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                     if(typeof window.saveAs !== 'undefined') {
                         saveAs(blob, filename);
                    } else {
                        const link = document.createElement("a");
                         link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
                     }
                 } catch(e) { console.error("Download error:", e); alert("Failed to initiate download."); }
            }

            function copyResultToClipboard() {
                 if (extractedContentCache) {
                     navigator.clipboard.writeText(extractedContentCache).then(() => {
                         const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                        setTimeout(() => { copyBtn.innerHTML = originalText; }, 2000);
                    }).catch(err => { console.error('Copy failed: ', err); alert('Failed to copy text.'); });
                } else { alert('No text content to copy.'); }
            }

            function resetState() {
                 currentFile = null; extractedContentCache = ''; selectedOption = 'ocr'; // Reset to OCR default
                 processingSection.classList.add('hidden'); resultSection.classList.add('hidden'); fileName.classList.add('hidden'); pdfInput.value = null; updateProgress(0); statusMessage.textContent = ''; tesseractLogContainer.classList.add('hidden'); tesseractLog.innerHTML = '';
                 // Ensure OCR option card is visually selected
                 optionCards.forEach(c => c.classList.remove('selected', 'border-blue-500'));
                 document.querySelector('.option-card[data-option="ocr"]').classList.add('selected', 'border-blue-500');
             }
         });
     </script>
    <!-- Ad Block -->
    <div class="w-full max-w-4xl mx-auto my-8 text-center">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9273434855071552"
             crossorigin="anonymous"></script>
        <!-- Reed -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-9273434855071552"
             data-ad-slot="6257062799"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
</body>
</html>