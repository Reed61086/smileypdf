<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Merger Tool</title>
     <!-- Base CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
     <!-- Additional Libraries from Source File (Violates Original Constraints) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <!-- Font Awesome (from source) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/downloadjs@1.4.7"></script> <!-- Required by source code -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .drop-zone {
            border: 2px dashed #9CA3AF;
            transition: all 0.3s ease;
        }
        .drop-zone.active {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }
        .preview-container {
            height: 300px;
            background-color: #F3F4F6;
        }
        .preview-thumb {
            height: 120px;
            object-fit: contain;
        }
        .sortable-ghost {
            opacity: 0.5;
            background: #DBEAFE;
        }
        
        /* Animation for file upload progress */
        @keyframes progressBar {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        .progress-bar {
            height: 4px;
            background-color: #3B82F6;
            animation: progressBar 2s ease-in-out; /* Removed animation for direct control */
             transition: width 0.5s ease; /* Added transition */
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
 <!-- Header -->
 <header x-data="{ mobileMenuOpen: false }" class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
        <div class="text-2xl font-bold">
             <a href="index.html" class="flex items-center transition duration-150 ease-in-out hover:opacity-80">
                <i class="fa-regular fa-face-smile mr-2 text-yellow-300"></i>SmileyPDF
             </a>
        </div>
        <!-- Desktop Menu -->
        <div class="hidden md:flex items-center space-x-4">
            <a href="index.html" class="hover:text-yellow-300 font-semibold px-3 py-2 rounded-md">Home</a>
            <!-- Tools Dropdown -->
             <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="hover:text-yellow-300 font-semibold focus:outline-none flex items-center px-3 py-2 rounded-md">
                    Tools <i class="fas fa-chevron-down ml-1 text-xs"></i>
                </button>
                <div x-show="open" @click.away="open = false"
                     x-transition:enter="transition ease-out duration-100 transform"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75 transform"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20 text-gray-700 py-1"
                     style="display: none;" x-cloak>
                     <a href="pdf-editor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF Editor</a>
                     <a href="merge-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Merge PDF</a>
                     <a href="image-to-pdf.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Image to PDF</a>
                     <a href="pdf-rotator.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Rotate PDF</a>
                     <a href="pdf-text-extractor.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Extract PDF Text</a>
                     <a href="pdf-to-jpg.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to JPG</a>
                     <a href="pdf-to-word.html" class="block px-4 py-2 text-sm hover:bg-gray-100">PDF to Word</a>
                 </div>
             </div>
         </div>
          <!-- Mobile Menu Button -->
          <div class="md:hidden">
              <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white focus:outline-none p-2 rounded hover:bg-blue-700">
                  <span class="sr-only">Open menu</span>
                  <i x-show="!mobileMenuOpen" class="fa-solid fa-bars text-xl"></i>
                  <i x-show="mobileMenuOpen" class="fa-solid fa-times text-xl" style="display: none;" x-cloak></i>
              </button>
         </div>
    </nav>
     <!-- Mobile Menu Panel -->
     <div x-show="mobileMenuOpen"
         class="md:hidden border-t border-blue-500"
         x-transition:enter="transition ease-out duration-200 transform origin-top"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-100 transform origin-top"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         style="display: none;" x-cloak>
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Home</a>
            <h3 class="px-3 pt-2 text-xs font-semibold text-blue-200 uppercase tracking-wider">Tools</h3>
            <a href="pdf-editor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF Editor</a>
            <a href="merge-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Merge PDF</a>
            <a href="image-to-pdf.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Image to PDF</a>
            <a href="pdf-rotator.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Rotate PDF</a>
            <a href="pdf-text-extractor.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">Extract PDF Text</a>
            <a href="pdf-to-jpg.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to JPG</a>
            <a href="pdf-to-word.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">PDF to Word</a>
        </div>
     </div>
</header>
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-blue-600 mb-3">PDF Merger Tool</h1>
            <p class="text-gray-600">Combine multiple PDF documents into one unified file with ease</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Upload PDF Files</h2>
                
                <!-- Drop Zone -->
                <div id="dropZone" class="drop-zone rounded-lg p-8 text-center cursor-pointer mb-6 hover:bg-blue-50 transition">
                    <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-file-pdf text-4xl text-red-500 mb-3"></i>
                        <p class="text-gray-600 font-medium">Drag & drop PDF files here or click to browse</p>
                        <p class="text-gray-400 text-sm mt-1">Supports multiple PDF files (No size limit)</p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept=".pdf" multiple>
                     <div id="fileInputProgressContainer" class="w-full bg-gray-200 rounded-full h-1 mt-4 hidden">
                        <div id="fileInputProgress" class="progress-bar bg-blue-600 h-1 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- File List Preview -->
                <div id="filePreviewContainer" class="hidden">
                    <h3 class="font-medium text-gray-700 mb-3">Selected Files (<span id="fileCount">0</span>) - Drag to reorder</h3>
                    
                    <div class="bg-gray-50 rounded-lg border border-gray-200 p-4 max-h-80 overflow-y-auto">
                        <ul id="fileList" class="divide-y divide-gray-200">
                            <!-- Files will be listed here -->
                             <li class="py-2 px-2 text-gray-400 text-center italic">No files selected</li>
                        </ul>
                    </div>
                    
                    <div class="flex justify-between items-center mt-4">
                        <button id="clearAllBtn" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center disabled:opacity-50" disabled>
                            <i class="fas fa-trash mr-1"></i> Clear All
                        </button>
                        <div id="totalSize" class="text-gray-500 text-sm">Total: 0 MB</div>
                    </div>
                </div>
            </div>

            <!-- Merge Options -->
            <div class="border-t border-gray-200 bg-gray-50 p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Merge Options</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Output Filename</label>
                        <div class="relative">
                            <input type="text" id="outputFilename" class="w-full pl-4 pr-12 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" value="merged_document">
                            <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">.pdf</span>
                        </div>
                    </div>
                    
                     <!-- Placeholder for other options like quality, linearization -->
                     <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1 invisible">Other Options</label> <!-- Placeholder Label -->
                          <div class="h-9"></div> <!-- Placeholder Div to match height -->
                      </div>
                 </div>
                
                <!-- Removed advanced options for simplicity based on original snippet focus -->
                <!-- <div class="flex items-center mb-4"> ... </div> -->
                <!-- <div class="flex items-center"> ... </div> -->
            </div>

            <!-- Merge Button -->
            <div class="bg-blue-50 border-t border-gray-200 p-6 text-center">
                <button id="mergeBtn" class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center mx-auto" disabled>
                    <i class="fas fa-object-group mr-2"></i> 
                    <span>Merge PDF Files</span>
                    <span id="mergeBtnLoader" class="ml-2 hidden">
                        <i class="fas fa-circle-notch fa-spin"></i>
                    </span>
                </button>
                
                <div id="successMessage" class="hidden mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>Files merged successfully! Your download will start shortly.</span>
                </div>
                
                <div id="errorMessage" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded flex items-center justify-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="errorText">An error occurred while merging files.</span>
                </div>
            </div>
        </div>

        <!-- How It Works Section -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">How to Merge PDFs</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="flex flex-col items-center text-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-upload text-blue-600"></i>
                        </div>
                        <h3 class="font-medium text-gray-800 mb-1">Upload Files</h3>
                        <p class="text-gray-600 text-sm">Select multiple PDF files or drag & drop them into the upload area.</p>
                    </div>
                    
                    <div class="flex flex-col items-center text-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-sort text-blue-600"></i>
                        </div>
                        <h3 class="font-medium text-gray-800 mb-1">Arrange Order</h3>
                        <p class="text-gray-600 text-sm">Drag files to reorder them as needed before merging.</p>
                    </div>
                    
                    <div class="flex flex-col items-center text-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-file-download text-blue-600"></i>
                        </div>
                        <h3 class="font-medium text-gray-800 mb-1">Download</h3>
                        <p class="text-gray-600 text-sm">Click "Merge PDF Files" to combine them into one document.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>Â© 2023 PDF Merger Tool. All rights reserved. | <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
             // Library Check
              if (typeof window.PDFLib === 'undefined' || typeof window.download === 'undefined') {
                  alert('Critical Error: Required libraries (pdf-lib, downloadjs) not loaded. Please check network connectivity and CDN links.');
                  console.error('pdf-lib or downloadjs not loaded.');
                  return;
              }
              const { PDFDocument } = window.PDFLib;


            // Elements
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const fileInputProgressContainer = document.getElementById('fileInputProgressContainer');
            const fileInputProgress = document.getElementById('fileInputProgress');
            const filePreviewContainer = document.getElementById('filePreviewContainer');
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            const totalSize = document.getElementById('totalSize');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const mergeBtn = document.getElementById('mergeBtn');
            const mergeBtnLoader = document.getElementById('mergeBtnLoader');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const outputFilenameInput = document.getElementById('outputFilename');
            
            let files = []; // Store File objects { id, file }
            let fileCounter = 0; // To give unique IDs
            let isProcessing = false;
            
            // ============ File Upload Functionality ============ //
            
            // Enable drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop zone
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            function highlight() { if (!isProcessing) dropZone.classList.add('active'); }
            function unhighlight() { dropZone.classList.remove('active'); }
            
            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);
             // Handle click to browse files
             dropZone.addEventListener('click', (e) => {
                // Ensure click is not on internal elements, or on button
                 if (!isProcessing && (e.target === dropZone || e.target.closest('.flex-col'))) {
                    fileInput.value = null; // Allow re-selecting same file(s)
                     fileInput.click();
                 }
             });
             // Handle file selection via browse button
             fileInput.addEventListener('change', (e) => {
                 if (!isProcessing) handleFiles(e.target.files);
             });

             function handleDrop(e) {
                 if (isProcessing) return;
                 const dt = e.dataTransfer;
                 const droppedFiles = dt.files;
                 if (droppedFiles.length > 0) handleFiles(droppedFiles);
                 else showError('No file detected in drop.');
             }
             
             function handleFiles(selectedFiles) {
                 if (selectedFiles.length === 0) return;
                 
                 // Filter only PDF files and check for duplicates based on name and size
                 const newFilesToAdd = Array.from(selectedFiles).filter(file =>
                     (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) &&
                     !files.some(f => f.file.name === file.name && f.file.size === file.size)
                 );
                 
                 if (newFilesToAdd.length > 0) {
                      startProgressIndication();
                     
                      newFilesToAdd.forEach(file => {
                         files.push({ id: fileCounter++, file: file });
                      });
                      
                      // Simulate upload/processing time
                      setTimeout(() => {
                         completeProgressIndication();
                          updateFileList();
                      }, 1000); // Simulate 1 second processing per batch

                  } else if (selectedFiles.length > 0) {
                     showError('Only valid, non-duplicate PDF files can be added.');
                  }
              }

             function startProgressIndication() {
                 isProcessing = true;
                 fileInputProgressContainer.classList.remove('hidden');
                 fileInputProgress.style.width = '0%';
                 // Animate progress
                 setTimeout(() => { fileInputProgress.style.width = '100%'; }, 50); // Start animation
             }
             function completeProgressIndication() {
                  setTimeout(() => {
                     fileInputProgressContainer.classList.add('hidden');
                     fileInputProgress.style.width = '0%';
                     isProcessing = false;
                 }, 500); // Delay hiding after completion
             }

             function showError(message) {
                 errorText.textContent = message;
                 errorMessage.classList.remove('hidden');
                 setTimeout(() => errorMessage.classList.add('hidden'), 5000);
             }

            // ============ File List Management ============ //
            
            function updateFileList() {
                fileList.innerHTML = ''; // Clear current list
                
                if (files.length === 0) {
                    fileList.innerHTML = '<li class="py-2 px-2 text-gray-400 text-center italic">No files selected</li>';
                    filePreviewContainer.classList.add('hidden');
                    mergeBtn.disabled = true;
                     clearAllBtn.disabled = true;
                    return;
                }
                
                filePreviewContainer.classList.remove('hidden');
                fileCount.textContent = files.length;
                
                const totalSizeBytes = files.reduce((sum, f) => sum + f.file.size, 0);
                const totalSizeMB = (totalSizeBytes / (1024 * 1024)).toFixed(2);
                totalSize.textContent = `Total: ${totalSizeMB} MB`;
                
                files.forEach((fileObj, index) => {
                    const file = fileObj.file;
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    
                    const li = document.createElement('li');
                    li.className = 'py-3 px-2 hover:bg-gray-100 rounded transition group cursor-move'; // Add cursor-move
                    li.draggable = true;
                    li.dataset.fileId = fileObj.id; // Use unique ID
                    
                    li.innerHTML = `
                        <div class="flex items-center pointer-events-none"> <!-- Prevent child dragging -->
                            <div class="w-10 h-10 bg-gray-200 rounded flex items-center justify-center mr-3 shrink-0">
                                <i class="fas fa-file-pdf text-red-500"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate" title="${file.name}">${file.name}</p>
                                <p class="text-xs text-gray-500">${fileSizeMB} MB</p>
                            </div>
                            <div class="flex items-center space-x-3 opacity-0 group-hover:opacity-100 transition pointer-events-auto"> <!-- Allow button clicks -->
                                <button class="move-up text-gray-400 hover:text-blue-600 tooltip">
                                    <i class="fas fa-arrow-up"></i>
                                    <span class="tooltip-text">Move up</span>
                                </button>
                                <button class="move-down text-gray-400 hover:text-blue-600 tooltip">
                                    <i class="fas fa-arrow-down"></i>
                                     <span class="tooltip-text">Move down</span>
                                </button>
                                <button class="remove-file text-gray-400 hover:text-red-600 tooltip">
                                    <i class="fas fa-times"></i>
                                     <span class="tooltip-text">Remove</span>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    fileList.appendChild(li);
                    
                    // Attach listeners to buttons inside the li
                    li.querySelector('.move-up').addEventListener('click', (e) => { e.stopPropagation(); moveFile(fileObj.id, 'up'); });
                    li.querySelector('.move-down').addEventListener('click', (e) => { e.stopPropagation(); moveFile(fileObj.id, 'down'); });
                    li.querySelector('.remove-file').addEventListener('click', (e) => { e.stopPropagation(); removeFile(fileObj.id); });
                });
                
                mergeBtn.disabled = files.length < 2;
                clearAllBtn.disabled = files.length === 0;
                initSortable(); // Re-initialize sorting after list update
            }
            
             // Move file by ID
            function moveFile(fileId, direction) {
                const index = files.findIndex(f => f.id === fileId);
                if (index === -1) return;

                if ((direction === 'up' && index === 0) || 
                    (direction === 'down' && index === files.length - 1)) {
                    return;
                }
                
                const newIndex = direction === 'up' ? index - 1 : index + 1;
                const fileToMove = files[index];
                
                files.splice(index, 1);
                files.splice(newIndex, 0, fileToMove);
                
                updateFileList();
            }
            
            // Remove file by ID
            function removeFile(fileId) {
                files = files.filter(f => f.id !== fileId);
                updateFileList();
            }
            
            clearAllBtn.addEventListener('click', () => {
                files = [];
                updateFileList();
            });
            
            // Drag and drop sorting initialization
            function initSortable() {
                 let draggedItem = null;
                 fileList.querySelectorAll('li[draggable="true"]').forEach(item => {
                     item.addEventListener('dragstart', function(e) {
                        draggedItem = this;
                        // Use dataTransfer for compatibility maybe? Although direct ref often works.
                        // e.dataTransfer.setData('text/plain', this.dataset.fileId);
                         setTimeout(() => this.classList.add('opacity-30'), 0); // Visual feedback
                     });
                     
                     item.addEventListener('dragend', function() {
                        this.classList.remove('opacity-30');
                        draggedItem = null;
                          // Clear any lingering ghost styles
                          fileList.querySelectorAll('.sortable-ghost').forEach(el => el.classList.remove('sortable-ghost'));
                    });
                    
                     item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                         const targetItem = e.target.closest('li[draggable="true"]');
                         if (targetItem && draggedItem && targetItem !== draggedItem) {
                             // Clear previous ghosts
                              fileList.querySelectorAll('.sortable-ghost').forEach(el => el.classList.remove('sortable-ghost'));
                             targetItem.classList.add('sortable-ghost'); // Add class to target
                         }
                    });

                     item.addEventListener('dragleave', function(e) {
                          const related = e.relatedTarget;
                          // Only remove ghost if leaving the list item entirely, not just moving over children
                         if (!this.contains(related)) {
                              this.classList.remove('sortable-ghost');
                         }
                     });

                     item.addEventListener('drop', function(e) {
                         e.preventDefault();
                        this.classList.remove('sortable-ghost'); // Remove ghost from target
                        if (!draggedItem || draggedItem === this) return;
                         
                         const fromId = parseInt(draggedItem.dataset.fileId);
                         const toId = parseInt(this.dataset.fileId);
                        
                        const fromIndex = files.findIndex(f => f.id === fromId);
                        const toIndex = files.findIndex(f => f.id === toId);

                        if(fromIndex !== -1 && toIndex !== -1) {
                              // Move the item in the files array
                              const fileToMove = files.splice(fromIndex, 1)[0];
                             files.splice(toIndex, 0, fileToMove);
                              updateFileList(); // Re-render the list based on new order
                        }
                     });
                });
             }
            
            // ============ Merge & Download Functionality ============ //
            function readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(reader.error);
                    reader.readAsArrayBuffer(file);
                });
            }


            
            async function createMergedPdf(fileObjects) {
                try {
                     const mergedPdf = await PDFDocument.create();
                    
                    for (const fileObj of fileObjects) {
                        const arrayBuffer = await readFileAsArrayBuffer(fileObj.file); // Read buffer
                        const pdfToCopy = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true }); // Try to ignore encryption issues

                         const pageIndices = pdfToCopy.getPageIndices();
                        const copiedPages = await mergedPdf.copyPages(pdfToCopy, pageIndices);
                        copiedPages.forEach(page => mergedPdf.addPage(page));
                        
                        // Optionally yield to allow UI updates during long processes
                         await new Promise(resolve => setTimeout(resolve, 5));
                    }
                    
                     // Save options (referencing UI elements for quality/optimization might go here)
                     const saveOptions = {};
                     if(document.getElementById('linearize')?.checked) {
                         saveOptions.useObjectStreams = false; // Linearization usually works better without object streams
                      }

                     const mergedPdfBytes = await mergedPdf.save(saveOptions);
                    return new Blob([mergedPdfBytes], { type: 'application/pdf' });
                 } catch (error) {
                    console.error('Error merging PDFs:', error);
                     // Check for specific errors like encryption
                     if(error.message && error.message.toLowerCase().includes('encrypted')) {
                        throw new Error(`Could not merge '${error.fileName || 'a file'}'. It may be password-protected.`); // Provide more specific feedback
                     }
                    throw error; // Re-throw other errors
                }
             }
            
             mergeBtn.addEventListener('click', async function() {
                 if (files.length < 2 || isProcessing) return;
                 
                 // Show loading state
                 isProcessing = true;
                 mergeBtnLoader.classList.remove('hidden');
                 mergeBtn.disabled = true;
                 mergeBtn.querySelector('span:not(#mergeBtnLoader)').textContent = 'Merging...'; // Update button text
                 successMessage.classList.add('hidden');
                 errorMessage.classList.add('hidden');
                 
                 try {
                     const filename = outputFilenameInput.value.trim() || 'merged_document';
                     const fullFilename = filename.endsWith('.pdf') ? filename : `${filename}.pdf`;
                     
                     // --- Indicate merging process start visually ---
                     successMessage.innerHTML = `
                         <i class="fas fa-circle-notch fa-spin mr-2"></i>
                         <span>Merging ${files.length} PDF files...</span>
                     `;
                     successMessage.classList.remove('hidden');
                     // --------------------------------------------------

                     const mergedBlob = await createMergedPdf(files);
                     
                     // Trigger the download using downloadjs
                      if (typeof window.download !== 'undefined') {
                          download(mergedBlob, fullFilename, "application/pdf");
                      } else if(typeof window.saveAs !== 'undefined') {
                           saveAs(mergedBlob, fullFilename); // Fallback to FileSaver
                       } else {
                            throw new Error("No download library available.");
                      }
                     
                     // Show success message
                     successMessage.innerHTML = `
                         <i class="fas fa-check-circle mr-2"></i>
                         <span>Files merged successfully! Download started for "${fullFilename}".</span>
                     `;
                      setTimeout(() => { successMessage.classList.add('hidden')}, 5000); // Auto-hide success

                 } catch (error) {
                      showError(error.message || 'Failed to merge PDF files. Please check console for details.');
                      console.error(error);
                 } finally {
                     // Reset loading state
                      isProcessing = false;
                      mergeBtnLoader.classList.add('hidden');
                      mergeBtn.disabled = files.length < 2; // Re-evaluate disabled state
                      mergeBtn.querySelector('span:not(#mergeBtnLoader)').textContent = 'Merge PDF Files';
                 }
             });

            // Call initially to set disabled states correctly
            updateFileList();

         });
     </script>
 </body>
 </html>